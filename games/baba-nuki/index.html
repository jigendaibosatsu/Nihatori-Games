<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ババ抜き – Nihatori Games</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    html { height: 100%; }
    body.game-page {
      margin: 0;
      padding-top: 48px;
      background: #0a5f2a;
      min-height: 100vh;
      min-height: 100dvh;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    .game-container {
      flex: 1 1 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
      padding: 0 clamp(0.5rem, 4%, 1rem);
      box-sizing: border-box;
    }
    .game-playfield {
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
    }
    .game-title {
      color: #fff;
      text-align: center;
      font-size: clamp(1rem, 4vw, 1.25rem);
      margin: 0 0 clamp(0.5rem, 2vw, 1rem);
      flex-shrink: 0;
    }
    .cpu-area {
      flex-shrink: 0;
      min-height: clamp(3rem, 15vmin, 5rem);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: clamp(2px, 1vmin, 4px);
      margin-bottom: clamp(0.5rem, 2vw, 1rem);
    }
    .cpu-area .card-back {
      width: clamp(32px, 10vmin, 48px);
      height: clamp(44px, 14vmin, 68px);
      border-radius: 6px;
      background: linear-gradient(135deg, #1a3a8a 0%, #2d5aa0 100%);
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .cpu-area .card-back.btn {
      padding: 0;
      margin: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .cpu-area .card-back.btn:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
    .cpu-area .card-back.btn:active { transform: scale(0.98); }
    .cpu-area .card-back.btn:disabled,
    .cpu-area.waiting .card-back.btn { cursor: default; pointer-events: none; opacity: 0.9; }
    .message {
      color: #fff;
      text-align: center;
      font-size: clamp(0.875rem, 2.5vw, 1rem);
      margin: clamp(0.5rem, 2vw, 0.75rem) 0;
      min-height: 1.5em;
      flex-shrink: 0;
    }
    .your-hand {
      flex: 1 1 0;
      min-height: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-content: flex-start;
      align-items: center;
      gap: clamp(4px, 1.5vmin, 6px);
      padding: clamp(0.5rem, 2vw, 0.75rem) 0;
    }
    .card {
      width: clamp(36px, 11vmin, 52px);
      height: clamp(50px, 15vmin, 72px);
      border-radius: clamp(4px, 1.5vmin, 8px);
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: clamp(12px, 3.5vmin, 18px);
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.15s;
      flex-shrink: 0;
    }
    .card.red { color: #c00; background: #fff; }
    .card.black { color: #111; background: #fff; }
    .card.joker {
      color: #c00;
      background: linear-gradient(135deg, #fff 0%, #ffe0e0 100%);
      font-size: clamp(10px, 2.5vmin, 14px);
    }
    .card .suit { font-size: 1em; }
    .card.selected { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }
    .card.disabled { opacity: 0.6; pointer-events: none; }
    .game-actionbar {
      flex-shrink: 0;
      padding: clamp(0.5rem, 2vw, 0.75rem) clamp(1rem, 4%, 1.5rem);
      padding-bottom: calc(clamp(0.5rem, 2vw, 0.75rem) + env(safe-area-inset-bottom, 0px));
      background: #0a5f2a;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: clamp(0.25rem, 1vw, 0.5rem);
    }
    .btn-draw, .btn-restart {
      display: block;
      width: 100%;
      max-width: 200px;
      padding: clamp(0.75rem, 3vw, 0.875rem) clamp(1rem, 4vw, 1.5rem);
      font-size: clamp(0.9375rem, 2.8vw, 1.1rem);
      font-weight: 700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    .btn-draw {
      color: #0a5f2a;
      background: #fff;
    }
    .btn-draw:active { transform: scale(0.98); }
    .btn-draw:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-restart {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 2px solid #fff;
    }
    .btn-restart:active { transform: scale(0.98); }
  </style>
</head>
<body class="game-page article-page">
  <div id="site-header"></div>

  <div class="game-container">
    <div class="game-playfield">
      <h1 class="game-title">ババ抜き</h1>

      <div class="cpu-area" id="cpu-area" aria-live="polite">
        <!-- CPUの手札（裏表示） -->
      </div>

      <p class="message" id="message">相手のカードを1枚タップして引くか、「1枚引く」でランダムに引きます。</p>

      <div class="your-hand" id="your-hand" role="list" aria-label="あなたの手札">
        <!-- あなたの手札 -->
      </div>
    </div>

    <div class="game-actionbar">
      <button type="button" class="btn-draw" id="btn-draw">1枚引く</button>
      <button type="button" class="btn-draw btn-restart" id="btn-restart" style="display:none;">もう一度遊ぶ</button>
    </div>
  </div>

  <script src="/assets/header.js"></script>
  <script>
(function () {
  'use strict';

  var SUITS = ['s', 'h', 'd', 'c'];
  var SUIT_SYMBOLS = { s: '♠', h: '♥', d: '♦', c: '♣' };
  var RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
  var RED_SUITS = ['h', 'd'];

  function createDeck() {
    var deck = [];
    for (var s = 0; s < SUITS.length; s++) {
      for (var r = 0; r < RANKS.length; r++) {
        deck.push({ rank: RANKS[r], suit: SUITS[s] });
      }
    }
    deck.push({ joker: true });
    return deck;
  }

  function shuffle(arr) {
    var a = arr.slice();
    for (var i = a.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var t = a[i]; a[i] = a[j]; a[j] = t;
    }
    return a;
  }

  function discardPairsSimple(hand) {
    var byRank = {};
    var jokers = [];
    for (var i = 0; i < hand.length; i++) {
      var c = hand[i];
      if (c.joker) { jokers.push(c); continue; }
      if (!byRank[c.rank]) byRank[c.rank] = [];
      byRank[c.rank].push(c);
    }
    var out = jokers.slice();
    for (var r in byRank) {
      var arr = byRank[r];
      while (arr.length >= 2) arr.pop(), arr.pop();
      if (arr.length === 1) out.push(arr[0]);
    }
    return out;
  }

  var state = {
    human: [],
    cpu: [],
    turn: 'human',
    phase: 'playing'
  };

  function renderCard(card) {
    if (card.joker) return '<span class="card joker">JOKER</span>';
    var red = RED_SUITS.indexOf(card.suit) >= 0;
    var cls = 'card ' + (red ? 'red' : 'black');
    return '<span class="' + cls + '" data-rank="' + card.rank + '" data-suit="' + card.suit + '">' + card.rank + '<span class="suit">' + SUIT_SYMBOLS[card.suit] + '</span></span>';
  }

  function renderYourHand() {
    var el = document.getElementById('your-hand');
    if (!el) return;
    el.innerHTML = state.human.map(function (c) { return renderCard(c); }).join('');
  }

  function renderCpuArea() {
    var el = document.getElementById('cpu-area');
    if (!el) return;
    var canPick = state.turn === 'human' && state.phase === 'playing' && state.cpu.length > 0;
    el.classList.toggle('waiting', !canPick);
    var html = '';
    for (var i = 0; i < state.cpu.length; i++) {
      if (canPick) {
        html += '<button type="button" class="card-back btn" data-index="' + i + '" aria-label="' + (i + 1) + '枚目を引く"> </button>';
      } else {
        html += '<span class="card-back"></span>';
      }
    }
    el.innerHTML = html || '<span class="card-back"></span>';
  }

  function initCpuAreaClick() {
    var el = document.getElementById('cpu-area');
    if (!el) return;
    el.addEventListener('click', function (e) {
      var btn = e.target.closest('.card-back.btn');
      if (!btn || el.classList.contains('waiting')) return;
      var idx = parseInt(btn.getAttribute('data-index'), 10);
      if (!isNaN(idx) && idx >= 0 && idx < state.cpu.length) humanDraw(idx);
    });
  }

  function setMessage(text) {
    var el = document.getElementById('message');
    if (el) el.textContent = text;
  }

  function humanDraw(cardIndex) {
    if (state.turn !== 'human' || state.phase !== 'playing' || state.cpu.length === 0) return;
    var i = typeof cardIndex === 'number' && cardIndex >= 0 && cardIndex < state.cpu.length
      ? cardIndex
      : Math.floor(Math.random() * state.cpu.length);
    var card = state.cpu.splice(i, 1)[0];
    state.human.push(card);
    state.human = discardPairsSimple(state.human);
    renderYourHand();
    renderCpuArea();
    if (state.human.length === 0) {
      state.phase = 'win';
      setMessage('あなたの勝ちです！');
      document.getElementById('btn-draw').style.display = 'none';
      document.getElementById('btn-restart').style.display = 'block';
      return;
    }
    if (state.cpu.length === 0) {
      state.phase = 'lose';
      setMessage('CPUの勝ちです。ババ（Joker）が残りました。');
      document.getElementById('btn-draw').style.display = 'none';
      document.getElementById('btn-restart').style.display = 'block';
      return;
    }
    state.turn = 'cpu';
    setMessage('CPUの番です…');
    document.getElementById('btn-draw').disabled = true;
    setTimeout(cpuTurn, 800);
  }

  function cpuTurn() {
    if (state.turn !== 'cpu' || state.human.length === 0) {
      document.getElementById('btn-draw').disabled = false;
      setMessage('あなたの番です。');
      state.turn = 'human';
      return;
    }
    var i = Math.floor(Math.random() * state.human.length);
    var card = state.human.splice(i, 1)[0];
    state.cpu.push(card);
    state.cpu = discardPairsSimple(state.cpu);
    renderYourHand();
    renderCpuArea();
    if (state.cpu.length === 0) {
      state.phase = 'lose';
      setMessage('CPUの勝ちです！');
      document.getElementById('btn-draw').style.display = 'none';
      document.getElementById('btn-restart').style.display = 'block';
      document.getElementById('btn-draw').disabled = false;
      return;
    }
    if (state.human.length === 0) {
      state.phase = 'win';
      setMessage('あなたの勝ちです！ CPUがババを持ちました。');
      document.getElementById('btn-draw').style.display = 'none';
      document.getElementById('btn-restart').style.display = 'block';
      document.getElementById('btn-draw').disabled = false;
      return;
    }
    state.turn = 'human';
    setMessage('相手のカードを1枚タップして引くか、「1枚引く」でランダムに引きます。');
    document.getElementById('btn-draw').disabled = false;
  }

  function startGame() {
    var deck = shuffle(createDeck());
    state.human = discardPairsSimple(deck.slice(0, 26));
    state.cpu = discardPairsSimple(deck.slice(26, 53));
    state.turn = 'human';
    state.phase = 'playing';
    renderYourHand();
    renderCpuArea();
    setMessage('相手のカードを1枚タップして引くか、「1枚引く」でランダムに引きます。');
    document.getElementById('btn-draw').style.display = 'block';
    document.getElementById('btn-draw').disabled = false;
    document.getElementById('btn-restart').style.display = 'none';
  }

  document.getElementById('btn-draw').addEventListener('click', function () { humanDraw(); });
  document.getElementById('btn-restart').addEventListener('click', startGame);
  initCpuAreaClick();

  startGame();
})();
  </script>
</body>
</html>
