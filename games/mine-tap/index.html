<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Mining Tap Game – Nihatori Games</title>
  <link rel="icon" href="/assets/icon/mine-tap.png" type="image/png" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "MS PGothic", "Yu Gothic", sans-serif;
      background: #1a1a2e;
      color: #fff;
      padding: 8px;
      min-height: 100vh;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin: 8px 0;
      color: #60a5fa;
      font-size: 1.3rem;
    }
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 4px;
    }
    .tab {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: #aaa;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab.active {
      background: #3b82f6;
      color: #fff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .stats-bar {
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      text-align: center;
    }
    .stat-item {
      padding: 6px;
      background: rgba(59,130,246,0.2);
      border-radius: 6px;
    }
    .stat-label {
      font-size: 10px;
      color: #aaa;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #60a5fa;
    }
    .stat-value.gold { color: #fbbf24; }
    .stat-value.gem { color: #a78bfa; }
    .mine-panel {
      text-align: center;
      padding: 20px 0;
    }
    .depth-info {
      margin-bottom: 16px;
    }
    .depth-value {
      font-size: 24px;
      font-weight: bold;
      color: #fbbf24;
      margin-bottom: 8px;
    }
    .block-hp-bar {
      width: 100%;
      height: 24px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 8px;
      position: relative;
    }
    .block-hp-fill {
      height: 100%;
      background: linear-gradient(90deg, #ef4444, #f87171);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 12px;
      font-weight: bold;
    }
    .tap-power {
      font-size: 14px;
      color: #34d399;
      margin-bottom: 16px;
    }
    .mine-button {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 4px solid #3b82f6;
      background: linear-gradient(180deg, #3b82f6, #2563eb);
      color: #fff;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      margin: 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s;
      touch-action: manipulation;
      user-select: none;
      box-shadow: 0 8px 16px rgba(59,130,246,0.4);
    }
    .mine-button:active {
      transform: scale(0.95);
      box-shadow: 0 4px 8px rgba(59,130,246,0.4);
    }
    .mine-button.flash {
      animation: flash 0.2s;
    }
    @keyframes flash {
      0%, 100% { background: linear-gradient(180deg, #3b82f6, #2563eb); }
      50% { background: linear-gradient(180deg, #22c55e, #16a34a); }
    }
    .log-panel {
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      padding: 10px;
      margin-top: 16px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 11px;
      line-height: 1.6;
    }
    .log-entry {
      margin-bottom: 4px;
      padding: 4px;
      border-left: 3px solid #3b82f6;
      padding-left: 8px;
    }
    .log-entry.rare { border-color: #3b82f6; color: #93c5fd; }
    .log-entry.epic { border-color: #a78bfa; color: #c4b5fd; }
    .log-entry.legendary { border-color: #fbbf24; color: #fde047; }
    .log-entry img {
      width: 16px;
      height: 16px;
      vertical-align: middle;
      margin-right: 4px;
      display: inline-block;
    }
    .reward-animation {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      font-size: 14px;
      font-weight: bold;
      color: #fbbf24;
      text-shadow: 0 0 4px rgba(0,0,0,0.8);
      animation: rewardFloat 2s ease-out forwards;
    }
    .reward-animation img {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 4px;
    }
    @keyframes rewardFloat {
      0% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(-80px) scale(1.2);
      }
    }
    .stat-item img {
      width: 20px;
      height: 20px;
      vertical-align: middle;
      margin-right: 4px;
    }
    .equipment-grid {
      display: grid;
      gap: 12px;
    }
    .equipment-section {
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      padding: 12px;
    }
    .section-title {
      font-size: 14px;
      font-weight: bold;
      color: #93c5fd;
      margin-bottom: 8px;
    }
    .equipment-card {
      background: rgba(59,130,246,0.2);
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .equipment-card:hover {
      background: rgba(59,130,246,0.4);
    }
    .equipment-card.equipped {
      border-color: #22c55e;
      background: rgba(34,197,94,0.2);
    }
    .equipment-card.rare { border-color: #3b82f6; }
    .equipment-card.epic { border-color: #a78bfa; }
    .equipment-card.legendary { border-color: #fbbf24; }
    .equipment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .equipment-name {
      font-weight: bold;
      font-size: 14px;
    }
    .equipment-rarity {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(255,255,255,0.2);
    }
    .equipment-stats {
      font-size: 11px;
      color: #d1d5db;
      line-height: 1.6;
    }
    .upgrade-list {
      display: grid;
      gap: 12px;
    }
    .upgrade-card {
      background: rgba(0,0,0,0.5);
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 12px;
    }
    .upgrade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .upgrade-name {
      font-weight: bold;
      font-size: 14px;
      color: #93c5fd;
    }
    .upgrade-cost {
      font-size: 12px;
      color: #fbbf24;
    }
    .upgrade-desc {
      font-size: 11px;
      color: #d1d5db;
      margin-bottom: 8px;
    }
    .upgrade-level {
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    .btn {
      width: 100%;
      padding: 10px;
      border: 2px solid #3b82f6;
      background: linear-gradient(180deg, #3b82f6, #2563eb);
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { transform: scale(1.02); }
    .btn:active { transform: scale(0.98); }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-danger {
      background: linear-gradient(180deg, #ef4444, #dc2626);
      border-color: #ef4444;
    }
    .lang-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .lang-select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 2px solid #3b82f6;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }
    .lang-select option {
      background: #1a1a2e;
      color: #fff;
    }
    .title-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
      padding: 24px;
      text-align: center;
    }
    .title-screen h1 {
      font-size: 1.8rem;
      margin-bottom: 32px;
      color: #60a5fa;
    }
    .title-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 280px;
      margin-bottom: 24px;
    }
    .title-buttons .btn {
      padding: 14px 24px;
      font-size: 16px;
    }
    .title-lang {
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .title-lang label {
      font-size: 12px;
      color: #94a3b8;
    }
    .game-screen {
      display: none;
    }
    .game-screen.active {
      display: block;
    }
    @media (max-width: 600px) {
      .stats-bar {
        grid-template-columns: 1fr;
      }
      .mine-button {
        width: 150px;
        height: 150px;
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Title Screen -->
  <div id="titleScreen" class="container title-screen">
    <h1 id="titleHeading">Mining Tap Game</h1>
    <div class="title-buttons">
      <button class="btn" id="btnNewGame">New Game</button>
      <button class="btn" id="btnContinue">Continue</button>
    </div>
    <div class="title-lang">
      <label for="titleLangSelect" id="titleLangLabel">Language</label>
      <select class="lang-select" id="titleLangSelect" aria-label="Language">
        <option value="en">English</option>
        <option value="es">Español</option>
        <option value="da">Dansk</option>
        <option value="ja">日本語</option>
      </select>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="container game-screen">
    <div class="lang-row">
      <h1 id="gameTitle">Mining Tap Game</h1>
    </div>
    
    <!-- リソース表示 -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-label" id="statGold">Gold</div>
        <div class="stat-value gold" id="goldValue">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label" id="statOre">Ore</div>
        <div class="stat-value" id="oreValue">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label" id="statGems">Gems</div>
        <div class="stat-value gem" id="gemValue">0</div>
      </div>
    </div>
    
    <!-- タブ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('mine')" id="tabMine">Mine</button>
      <button class="tab" onclick="switchTab('equipment')" id="tabEquipment">Equipment</button>
      <button class="tab" onclick="switchTab('upgrade')" id="tabUpgrade">Upgrade</button>
      <button class="tab" onclick="switchTab('shop')" id="tabShop">Shop</button>
    </div>
    
    <!-- 掘るタブ -->
    <div id="mineTab" class="tab-content active">
      <div class="mine-panel">
        <div class="depth-info">
          <div class="depth-value"><span id="depthLabel">Depth</span>: <span id="depthValue">1</span>m</div>
          <div class="block-hp-bar">
            <div class="block-hp-fill" id="blockHpFill">100/100</div>
          </div>
          <div class="tap-power"><span id="tapPowerLabel">Mining power</span>: <span id="tapPowerValue">10</span></div>
          <div id="toolDurabilityBar" style="margin-top:8px; display:none;">
            <div style="font-size:11px; color:#aaa; margin-bottom:4px;" id="toolDurabilityLabel">Pickaxe durability</div>
            <div class="block-hp-bar" style="height:16px;">
              <div class="block-hp-fill" id="toolDurabilityFill" style="background:linear-gradient(90deg, #22c55e, #16a34a); font-size:10px;">100/100</div>
            </div>
          </div>
        </div>
        <button class="mine-button" id="mineButton" onclick="mine()">Mine</button>
        <div class="log-panel" id="mineLog"></div>
      </div>
    </div>
    
    <!-- 装備タブ -->
    <div id="equipmentTab" class="tab-content">
      <div class="equipment-grid">
        <div class="equipment-section">
          <div class="section-title" id="sectionEquipped">Equipped</div>
          <div id="equippedTool"></div>
        </div>
        <div class="equipment-section">
          <div class="section-title" id="sectionInventory">Inventory</div>
          <div id="inventoryList"></div>
        </div>
      </div>
    </div>
    
    <!-- 強化タブ -->
    <div id="upgradeTab" class="tab-content">
      <div class="upgrade-list">
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-name" id="upgradeToolName">Pickaxe Upgrade</div>
            <div class="upgrade-cost" id="toolUpgradeCost">Gold: 10</div>
          </div>
          <div class="upgrade-desc" id="upgradeToolDesc">Mining power +2</div>
          <div class="upgrade-level"><span id="levelLabel">Level</span>: <span id="toolLevel">1</span></div>
          <button class="btn" id="toolUpgradeBtn" onclick="upgradeTool()">Upgrade</button>
        </div>
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-name" id="upgradeGoldName">Gold Bonus+</div>
            <div class="upgrade-cost" id="goldBonusCost">Gold: 100</div>
          </div>
          <div class="upgrade-desc" id="upgradeGoldDesc">Gold gain +5%</div>
          <div class="upgrade-level"><span id="levelLabel2">Level</span>: <span id="goldBonusLevel">0</span></div>
          <button class="btn" id="goldBonusBtn" onclick="upgradeGoldBonus()">Upgrade</button>
        </div>
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-name" id="upgradeOreName">Ore Bonus+</div>
            <div class="upgrade-cost" id="oreBonusCost">Gold: 100</div>
          </div>
          <div class="upgrade-desc" id="upgradeOreDesc">Ore gain +5%</div>
          <div class="upgrade-level"><span id="levelLabel3">Level</span>: <span id="oreBonusLevel">0</span></div>
          <button class="btn" id="oreBonusBtn" onclick="upgradeOreBonus()">Upgrade</button>
        </div>
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-name" id="upgradeCritName">Critical Rate+</div>
            <div class="upgrade-cost" id="critChanceCost">Ore: 50</div>
          </div>
          <div class="upgrade-desc" id="upgradeCritDesc">Critical rate +1%</div>
          <div class="upgrade-level"><span id="levelLabel4">Level</span>: <span id="critChanceLevel">0</span></div>
          <button class="btn" id="critChanceBtn" onclick="upgradeCritChance()">Upgrade</button>
        </div>
      </div>
      
      <!-- レア武器開発解除 -->
      <div style="margin-top:24px;">
        <div class="section-title" id="rareWeaponsTitle" style="font-size:16px; margin-bottom:12px;">Rare Weapon Development</div>
        <div id="rareWeaponsList"></div>
      </div>
      <div style="margin-top:16px; text-align:center;">
        <button class="btn btn-danger" onclick="resetGame()" id="resetBtn">Reset</button>
      </div>
    </div>
    
    <!-- ショップタブ -->
    <div id="shopTab" class="tab-content">
      <div class="equipment-grid">
        <div class="equipment-section">
          <div class="section-title" id="shopEquipmentTitle">Sell Equipment</div>
          <div id="shopEquipmentList"></div>
        </div>
        <div class="equipment-section">
          <div class="section-title" id="shopOreTitle">Sell Ore</div>
          <div id="shopOreList"></div>
        </div>
        <div class="equipment-section">
          <div class="section-title" id="shopGemTitle">Exchange Gems</div>
          <div id="shopGemList"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="src/i18n.js"></script>
  <script>
    // ===== i18n helper =====
    function t(key, params) {
      return (window.i18n && window.i18n.t) ? window.i18n.t(key, params) : key;
    }

    function getOreName(type) { return t('ore.' + type); }
    function getGemName(type) { return t('gem.' + type); }
    function getGemSizeName(size) { return t('gemSize.' + size); }
    function getRarityName(r) { return t('rarity.' + r); }
    function getToolName(key) { return t('tool.' + (key || 'pickaxe')); }
    function getRareWeaponName(key) { return t('rareWeapon.' + key); }
    function getEquipmentDisplayName(eq) {
      if (!eq) return '';
      if (eq.nameKey === 'basePickaxe') return getToolName('basePickaxe');
      if (eq.nameKey && RARE_WEAPONS[eq.nameKey]) return getRareWeaponName(eq.nameKey);
      if (eq.nameKey === 'pickaxe') return getToolName('pickaxe');
      return eq.name || getToolName('pickaxe');
    }

    // ===== 定数定義 =====
    const ORE_TYPES = {
      iron: { depthRange: [1, 30], image: '/assets/ores/iron_ore.png' },
      silver: { depthRange: [31, 80], image: '/assets/ores/silver_ore.png' },
      gold: { depthRange: [81, 150], image: '/assets/ores/gold_ore.png' },
      crystal: { depthRange: [151, Infinity], image: '/assets/ores/cristal_blue.png' }
    };

    // アセットパスマッピング
    const ASSET_PATHS = {
      coin: '/assets/money/coin_32.png',
      goldCoin: '/assets/money/gold_coins128.png',
      gems: {
        ruby: '/assets/ores/ruby.png',
        sapphire: '/assets/ores/sapphire.png',
        emerald: '/assets/ores/emerald.png',
        diamond: '/assets/ores/diamond.png',
        amethyst: '/assets/ores/amegist.png',
        topaz: '/assets/ores/topaz.png'
      }
    };

    const RARITY = {
      common: { color: '#94a3b8', chance: 0.78 },
      rare: { color: '#3b82f6', chance: 0.18 },
      epic: { color: '#a78bfa', chance: 0.035 },
      legendary: { color: '#fbbf24', chance: 0.005 }
    };

    const BASE_TAP_POWER = 10;
    const TOOL_UPGRADE_BASE_COST = 10;
    const TOOL_UPGRADE_COST_MULT = 1.22;
    const TOOL_UPGRADE_POWER = 2;

    // 基本ツルハシ
    const BASE_PICKAXE = {
      id: 'base-pickaxe',
      type: 'tool',
      nameKey: 'basePickaxe',
      rarity: 'common',
      durability: 100,
      maxDurability: 100,
      stats: {
        tapPower: 0,
        tapPowerPercent: 0,
        goldBonus: 0,
        oreBonus: 0
      }
    };

    // 宝石の種類
    const GEM_TYPES = {
      ruby: { basePrice: 100 },
      sapphire: { basePrice: 120 },
      emerald: { basePrice: 150 },
      diamond: { basePrice: 200 },
      amethyst: { basePrice: 80 },
      topaz: { basePrice: 90 }
    };

    // 宝石のサイズ
    const GEM_SIZES = {
      small: { multiplier: 1.0 },
      medium: { multiplier: 1.5 },
      large: { multiplier: 2.5 }
    };

    // レア武器（開発解除可能なツルハシ）
    const RARE_WEAPONS = {
      thunder: {
        nameKey: 'thunder',
        rarity: 'rare',
        requiredOres: { iron: 50, silver: 30 },
        stats: {
          tapPower: 15,
          tapPowerPercent: 20,
          goldBonus: 10,
          oreBonus: 10
        },
        durability: 200,
        maxDurability: 200
      },
      ice: {
        nameKey: 'ice',
        rarity: 'epic',
        requiredOres: { silver: 50, gold: 30, crystal: 10 },
        stats: {
          tapPower: 25,
          tapPowerPercent: 30,
          goldBonus: 15,
          oreBonus: 20
        },
        durability: 300,
        maxDurability: 300
      },
      flame: {
        nameKey: 'flame',
        rarity: 'epic',
        requiredOres: { gold: 50, crystal: 30 },
        stats: {
          tapPower: 30,
          tapPowerPercent: 25,
          goldBonus: 20,
          oreBonus: 15
        },
        durability: 350,
        maxDurability: 350
      },
      mythic: {
        nameKey: 'mythic',
        rarity: 'legendary',
        requiredOres: { crystal: 100, gold: 80 },
        stats: {
          tapPower: 50,
          tapPowerPercent: 50,
          goldBonus: 30,
          oreBonus: 30
        },
        durability: 500,
        maxDurability: 500
      }
    };

    // 鉱物の基本価格
    const ORE_PRICES = {
      iron: 5,
      silver: 15,
      gold: 50,
      crystal: 200
    };

    const STORAGE_KEY = 'mine-tap-save';
    const AUTO_SAVE_INTERVAL = 5000; // 5秒

    // ===== ゲーム状態 =====
    let gameState = {
      depth: 1,
      currentBlockHp: 0,
      currentBlockMaxHp: 0,
      
      resources: {
        gold: 0,
        ore: { iron: 0, silver: 0, gold: 0, crystal: 0 },
        gems: [] // 宝石を配列で管理（各宝石に種類とサイズを持つ）
      },
      
      tool: {
        level: 1,
        equipped: null
      },
      
      inventory: [],
      
      upgrades: {
        goldBonus: 0,
        oreBonus: 0,
        critChance: 0
      },
      
      unlockedWeapons: [], // 開発解除済みの武器ID
      
      lastSaveTime: Date.now()
    };

    // ===== 初期化 =====
    function initGame() {
      gameState.depth = 1;
      gameState.resources = { gold: 0, ore: { iron: 0, silver: 0, gold: 0, crystal: 0 }, gems: [] };
      gameState.tool = { level: 1, equipped: null };
      gameState.inventory = [];
      gameState.upgrades = { goldBonus: 0, oreBonus: 0, critChance: 0 };
      gameState.unlockedWeapons = [];
      
      // 基本ツルハシを自動装備
      const basePickaxe = JSON.parse(JSON.stringify(BASE_PICKAXE));
      basePickaxe.id = 'base-pickaxe-' + Date.now();
      gameState.tool.equipped = basePickaxe;
      
      generateBlock();
      updateUI();
    }

    // 基本ツルハシを生成
    function createBasePickaxe() {
      const basePickaxe = JSON.parse(JSON.stringify(BASE_PICKAXE));
      basePickaxe.id = 'base-pickaxe-' + Date.now();
      return basePickaxe;
    }

    // ツルハシが壊れた時の処理（自動装備）
    function breakTool() {
      if (!gameState.tool.equipped) return;
      
      addLog(t('game.toolBroke', { name: getEquipmentDisplayName(gameState.tool.equipped) }), 'rare');
      
      // インベントリから新しいツルハシを探す
      const toolIndex = gameState.inventory.findIndex(eq => eq.type === 'tool');
      if (toolIndex >= 0) {
        // インベントリから装備
        const newTool = gameState.inventory[toolIndex];
        gameState.tool.equipped = newTool;
        gameState.inventory.splice(toolIndex, 1);
        addLog(t('game.autoEquip', { name: getEquipmentDisplayName(newTool) }), newTool.rarity);
      } else {
        // 基本ツルハシを生成して装備
        const basePickaxe = createBasePickaxe();
        gameState.tool.equipped = basePickaxe;
        addLog(t('game.basePickaxeEquip'), 'common');
      }
    }

    function generateBlock() {
      const depth = gameState.depth;
      gameState.currentBlockMaxHp = Math.floor(10 + Math.pow(depth, 1.15) * 2.5);
      gameState.currentBlockHp = gameState.currentBlockMaxHp;
    }

    // ===== 掘削システム =====
    function calculateTapPower() {
      let power = BASE_TAP_POWER;
      power += (gameState.tool.level - 1) * TOOL_UPGRADE_POWER;
      
      if (gameState.tool.equipped) {
        const tool = gameState.tool.equipped;
        power += tool.stats.tapPower || 0;
        power = Math.floor(power * (1 + (tool.stats.tapPowerPercent || 0) / 100));
      }
      
      return power;
    }

    function mine() {
      // ツルハシがない場合は基本ツルハシを装備
      if (!gameState.tool.equipped) {
        const basePickaxe = createBasePickaxe();
        gameState.tool.equipped = basePickaxe;
      }
      
      const tapPower = calculateTapPower();
      let damage = tapPower;
      
      // クリティカル判定
      const critChance = gameState.upgrades.critChance;
      if (Math.random() < critChance / 100) {
        damage = Math.floor(damage * 2);
        addLog(t('game.critical'), 'epic');
      }
      
      gameState.currentBlockHp -= damage;
      
      // ツルハシの耐久力を減少
      if (gameState.tool.equipped) {
        if (gameState.tool.equipped.durability === undefined) {
          gameState.tool.equipped.durability = gameState.tool.equipped.maxDurability || 100;
        }
        gameState.tool.equipped.durability--;
        
        // 耐久力が0になったら壊れる
        if (gameState.tool.equipped.durability <= 0) {
          breakTool();
        }
      }
      
      // ボタン演出
      const btn = document.getElementById('mineButton');
      btn.classList.add('flash');
      setTimeout(() => btn.classList.remove('flash'), 200);
      
      if (gameState.currentBlockHp <= 0) {
        destroyBlock();
      }
      
      updateUI();
      checkAutoSave();
    }

    function destroyBlock() {
      // 報酬ドロップ
      dropRewards();
      
      // 次の深度へ
      gameState.depth++;
      generateBlock();
      
      addLog(t('game.depthReached', { n: gameState.depth }), 'rare');
    }

    function dropRewards() {
      const depth = gameState.depth;
      
      // Gold獲得
      const baseGold = 1 + Math.floor(Math.random() * 3) + Math.floor(depth / 5);
      const goldBonus = 1 + gameState.upgrades.goldBonus * 0.05;
      const goldGained = Math.floor(baseGold * goldBonus);
      if (goldGained > 0) {
        gameState.resources.gold += goldGained;
        showRewardAnimation(goldGained, ASSET_PATHS.coin, 'Gold');
        addLog(`<img src="${ASSET_PATHS.coin}" alt="Gold" />${t('game.goldGain', { n: goldGained })}`, 'rare');
      }
      
      // Ore獲得
      let oreType = 'iron';
      for (const [type, data] of Object.entries(ORE_TYPES)) {
        if (depth >= data.depthRange[0] && depth <= data.depthRange[1]) {
          oreType = type;
          break;
        }
      }
      
      const baseOre = Math.random() < 0.7 ? 1 : 0; // 70%で1個
      const oreBonus = 1 + gameState.upgrades.oreBonus * 0.05;
      const oreGained = baseOre > 0 ? Math.floor(baseOre * oreBonus) : 0;
      if (oreGained > 0) {
        gameState.resources.ore[oreType] += oreGained;
        const oreData = ORE_TYPES[oreType];
        showRewardAnimation(oreGained, oreData.image, getOreName(oreType));
        addLog(`<img src="${oreData.image}" alt="${getOreName(oreType)}" />${t('game.oreGain', { name: getOreName(oreType), n: oreGained })}`, 'rare');
      }
      
      // 装備ドロップ（低確率）
      if (Math.random() < 0.05) { // 5%で装備ドロップ
        dropEquipment();
      }
      
      // 宝石ドロップ（超低確率）
      if (Math.random() < 0.01) { // 1%で宝石
        const gemTypes = Object.keys(GEM_TYPES);
        const gemSizes = Object.keys(GEM_SIZES);
        const gemType = gemTypes[Math.floor(Math.random() * gemTypes.length)];
        const gemSize = gemSizes[Math.floor(Math.random() * gemSizes.length)];
        
        const gem = {
          id: Date.now() + Math.random(),
          type: gemType,
          size: gemSize
        };
        
        gameState.resources.gems.push(gem);
        const gemImage = ASSET_PATHS.gems[gemType] || ASSET_PATHS.gems.ruby;
        showRewardAnimation(1, gemImage, getGemName(gemType), 'legendary');
        addLog(`<img src="${gemImage}" alt="${getGemName(gemType)}" />${t('game.gemFound', { size: getGemSizeName(gemSize), name: getGemName(gemType) })}`, 'legendary');
      }
    }

    // 獲得アイテムのアニメーション表示
    function showRewardAnimation(amount, imagePath, name, rarity = 'rare') {
      const mineButton = document.getElementById('mineButton');
      const rect = mineButton.getBoundingClientRect();
      const x = rect.left + rect.width / 2;
      const y = rect.top + rect.height / 2;
      
      const rewardEl = document.createElement('div');
      rewardEl.className = 'reward-animation';
      rewardEl.style.left = x + 'px';
      rewardEl.style.top = y + 'px';
      rewardEl.style.color = rarity === 'legendary' ? '#fbbf24' : rarity === 'epic' ? '#a78bfa' : '#60a5fa';
      
      const img = document.createElement('img');
      img.src = imagePath;
      img.alt = name;
      rewardEl.appendChild(img);
      
      const text = document.createTextNode(`+${amount} ${name}`);
      rewardEl.appendChild(text);
      
      document.body.appendChild(rewardEl);
      
      setTimeout(() => {
        if (rewardEl.parentNode) {
          rewardEl.parentNode.removeChild(rewardEl);
        }
      }, 2000);
    }

    function dropEquipment() {
      // レアリティ抽選
      const rand = Math.random();
      let rarity = 'common';
      let cumulative = 0;
      for (const [key, data] of Object.entries(RARITY)) {
        cumulative += data.chance;
        if (rand <= cumulative) {
          rarity = key;
          break;
        }
      }
      
      // 装備タイプ（MVPはツルハシのみ）
      const equipment = {
        id: Date.now() + Math.random(),
        type: 'tool',
        nameKey: 'pickaxe',
        rarity: rarity,
        durability: 100,
        maxDurability: 100,
        stats: generateEquipmentStats(rarity)
      };
      
      gameState.inventory.push(equipment);
      addLog(t('game.equipmentDrop', { rarity: getRarityName(rarity), name: getEquipmentDisplayName(equipment) }), rarity);
    }

    function generateEquipmentStats(rarity) {
      const multipliers = {
        common: 1,
        rare: 1.5,
        epic: 2.5,
        legendary: 4
      };
      const mult = multipliers[rarity] || 1;
      
      return {
        tapPower: Math.floor((Math.random() * 5 + 2) * mult),
        tapPowerPercent: Math.floor((Math.random() * 10 + 5) * mult),
        goldBonus: Math.floor((Math.random() * 5 + 2) * mult),
        oreBonus: Math.floor((Math.random() * 5 + 2) * mult)
      };
    }

    // ===== 装備システム =====
    function equipTool(equipment) {
      gameState.tool.equipped = equipment;
      updateUI();
      addLog(t('game.equipped', { name: getEquipmentDisplayName(equipment) }), equipment.rarity);
    }

    function unequipTool() {
      if (gameState.tool.equipped) {
        gameState.inventory.push(gameState.tool.equipped);
        gameState.tool.equipped = null;
        // 装備を外したら基本ツルハシを自動装備
        const basePickaxe = createBasePickaxe();
        gameState.tool.equipped = basePickaxe;
        updateUI();
        addLog(t('game.basePickaxeEquip'), 'common');
        checkAutoSave();
      }
    }

    // ===== 強化システム =====
    function upgradeTool() {
      const cost = Math.floor(TOOL_UPGRADE_BASE_COST * Math.pow(TOOL_UPGRADE_COST_MULT, gameState.tool.level - 1));
      if (gameState.resources.gold < cost) {
        alert(t('game.notEnoughGold'));
        return;
      }
      
      gameState.resources.gold -= cost;
      gameState.tool.level++;
      updateUI();
      checkAutoSave();
    }

    function upgradeGoldBonus() {
      const cost = 100 * Math.pow(1.5, gameState.upgrades.goldBonus);
      if (gameState.resources.gold < cost) {
        alert(t('game.notEnoughGold'));
        return;
      }
      
      gameState.resources.gold -= cost;
      gameState.upgrades.goldBonus++;
      updateUI();
      checkAutoSave();
    }

    function upgradeOreBonus() {
      const cost = 100 * Math.pow(1.5, gameState.upgrades.oreBonus);
      if (gameState.resources.gold < cost) {
        alert(t('game.notEnoughGold'));
        return;
      }
      
      gameState.resources.gold -= cost;
      gameState.upgrades.oreBonus++;
      updateUI();
      checkAutoSave();
    }

    function upgradeCritChance() {
      const cost = 50 * Math.pow(1.5, gameState.upgrades.critChance);
      const totalOre = Object.values(gameState.resources.ore).reduce((a, b) => a + b, 0);
      if (totalOre < cost) {
        alert(t('game.notEnoughOre'));
        return;
      }
      
      // Ore消費（優先順位：クリスタル > 金 > 銀 > 鉄）
      let remaining = cost;
      const order = ['crystal', 'gold', 'silver', 'iron'];
      for (const type of order) {
        if (remaining <= 0) break;
        const consume = Math.min(remaining, gameState.resources.ore[type]);
        gameState.resources.ore[type] -= consume;
        remaining -= consume;
      }
      
      gameState.upgrades.critChance++;
      updateUI();
      checkAutoSave();
    }

    // ===== UI更新 =====
    function updateUI() {
      // リソース表示（画像付き）
      const goldEl = document.getElementById('goldValue');
      goldEl.innerHTML = `<img src="${ASSET_PATHS.coin}" alt="Gold" />${formatNumber(gameState.resources.gold)}`;
      
      const oreEl = document.getElementById('oreValue');
      const totalOre = Object.values(gameState.resources.ore).reduce((a, b) => a + b, 0);
      // 最も多い鉱石の画像を表示
      let maxOreType = 'iron';
      let maxOreCount = 0;
      for (const [type, count] of Object.entries(gameState.resources.ore)) {
        if (count > maxOreCount) {
          maxOreCount = count;
          maxOreType = type;
        }
      }
      const oreImage = ORE_TYPES[maxOreType]?.image || ORE_TYPES.iron.image;
      oreEl.innerHTML = totalOre > 0 ? `<img src="${oreImage}" alt="Ore" />${totalOre}` : '0';
      
      const gemEl = document.getElementById('gemValue');
      const gemCount = Array.isArray(gameState.resources.gems) ? gameState.resources.gems.length : gameState.resources.gems;
      if (gemCount > 0 && gameState.resources.gems.length > 0) {
        const firstGem = gameState.resources.gems[0];
        const gemImage = ASSET_PATHS.gems[firstGem.type] || ASSET_PATHS.gems.ruby;
        gemEl.innerHTML = `<img src="${gemImage}" alt="Gem" />${gemCount}`;
      } else {
        gemEl.textContent = '0';
      }
      
      // 掘削画面
      document.getElementById('depthValue').textContent = gameState.depth;
      const hpPercent = (gameState.currentBlockHp / gameState.currentBlockMaxHp) * 100;
      document.getElementById('blockHpFill').style.width = hpPercent + '%';
      document.getElementById('blockHpFill').textContent = 
        `${Math.max(0, Math.floor(gameState.currentBlockHp))}/${gameState.currentBlockMaxHp}`;
      document.getElementById('tapPowerValue').textContent = calculateTapPower();
      
      // ツルハシの耐久力表示
      const toolDurabilityBar = document.getElementById('toolDurabilityBar');
      const toolDurabilityFill = document.getElementById('toolDurabilityFill');
      if (gameState.tool.equipped && gameState.tool.equipped.durability !== undefined) {
        toolDurabilityBar.style.display = 'block';
        const durability = gameState.tool.equipped.durability;
        const maxDurability = gameState.tool.equipped.maxDurability || 100;
        const durabilityPercent = (durability / maxDurability) * 100;
        toolDurabilityFill.style.width = durabilityPercent + '%';
        toolDurabilityFill.textContent = `${Math.max(0, Math.floor(durability))}/${maxDurability}`;
        
        // 耐久力が低い場合は色を変える
        if (durabilityPercent < 20) {
          toolDurabilityFill.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
        } else if (durabilityPercent < 50) {
          toolDurabilityFill.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
        } else {
          toolDurabilityFill.style.background = 'linear-gradient(90deg, #22c55e, #16a34a)';
        }
      } else {
        toolDurabilityBar.style.display = 'none';
      }
      
      // 装備画面
      updateEquipmentUI();
      
      // 強化画面
      updateUpgradeUI();
      updateRareWeaponsUI();
      
      // ショップ画面
      updateShopUI();
    }

    function updateEquipmentUI() {
      // 装備中
      const equippedDiv = document.getElementById('equippedTool');
      equippedDiv.innerHTML = '';
      if (gameState.tool.equipped) {
        const tool = gameState.tool.equipped;
        equippedDiv.appendChild(createEquipmentCard(tool, true));
      } else {
        equippedDiv.innerHTML = '<div style="color:#666; padding:20px; text-align:center;">' + t('ui.noEquipment') + '</div>';
      }
      
      // 所持品
      const inventoryDiv = document.getElementById('inventoryList');
      inventoryDiv.innerHTML = '';
      if (gameState.inventory.length === 0) {
        inventoryDiv.innerHTML = '<div style="color:#666; padding:20px; text-align:center;">' + t('ui.noInventory') + '</div>';
      } else {
        // レアリティ順にソート
        const sorted = [...gameState.inventory].sort((a, b) => {
          const order = ['common', 'rare', 'epic', 'legendary'];
          return order.indexOf(b.rarity) - order.indexOf(a.rarity);
        });
        sorted.forEach(eq => {
          inventoryDiv.appendChild(createEquipmentCard(eq, false));
        });
      }
    }

    function createEquipmentCard(equipment, isEquipped) {
      const rarity = RARITY[equipment.rarity];
      const stats = equipment.stats;
      let statsText = '';
      if (stats.tapPower) statsText += `${t('stats.tapPower')}+${stats.tapPower} `;
      if (stats.tapPowerPercent) statsText += `${t('stats.tapPowerPercent')}+${stats.tapPowerPercent}% `;
      if (stats.goldBonus) statsText += `${t('stats.goldBonus')}+${stats.goldBonus}% `;
      if (stats.oreBonus) statsText += `${t('stats.oreBonus')}+${stats.oreBonus}% `;
      
      // 耐久力表示
      let durabilityText = '';
      if (equipment.durability !== undefined && equipment.maxDurability !== undefined) {
        const durabilityPercent = (equipment.durability / equipment.maxDurability) * 100;
        let durabilityColor = '#22c55e';
        if (durabilityPercent < 20) durabilityColor = '#ef4444';
        else if (durabilityPercent < 50) durabilityColor = '#f59e0b';
        durabilityText = `<div style="font-size:10px; color:${durabilityColor}; margin-top:4px;">${t('ui.durability')}: ${Math.max(0, Math.floor(equipment.durability))}/${equipment.maxDurability}</div>`;
      }
      
      const card = document.createElement('div');
      card.className = `equipment-card ${equipment.rarity} ${isEquipped ? 'equipped' : ''}`;
      card.innerHTML = `
        <div class="equipment-header">
          <div class="equipment-name">${getEquipmentDisplayName(equipment)}</div>
          <div class="equipment-rarity" style="background:${rarity.color}20; color:${rarity.color}">
            ${getRarityName(equipment.rarity)}
          </div>
        </div>
        <div class="equipment-stats">${statsText || t('ui.noStats')}</div>
        ${durabilityText}
      `;
      
      if (isEquipped) {
        card.onclick = unequipTool;
      } else {
        card.onclick = () => {
          const index = gameState.inventory.findIndex(eq => eq.id === equipment.id);
          if (index >= 0) {
            if (gameState.tool.equipped) {
              gameState.inventory.push(gameState.tool.equipped);
            }
            gameState.tool.equipped = equipment;
            gameState.inventory.splice(index, 1);
            updateUI();
            addLog(t('game.equipped', { name: getEquipmentDisplayName(equipment) }), equipment.rarity);
            checkAutoSave();
          }
        };
      }
      
      return card;
    }

    function updateUpgradeUI() {
      // ツルハシ強化
      const toolCost = Math.floor(TOOL_UPGRADE_BASE_COST * Math.pow(TOOL_UPGRADE_COST_MULT, gameState.tool.level - 1));
      document.getElementById('toolUpgradeCost').textContent = t('game.costGold', { n: formatNumber(toolCost) });
      document.getElementById('toolLevel').textContent = gameState.tool.level;
      document.getElementById('toolUpgradeBtn').disabled = gameState.resources.gold < toolCost;
      
      // Gold獲得+
      const goldCost = Math.floor(100 * Math.pow(1.5, gameState.upgrades.goldBonus));
      document.getElementById('goldBonusCost').textContent = t('game.costGold', { n: formatNumber(goldCost) });
      document.getElementById('goldBonusLevel').textContent = gameState.upgrades.goldBonus;
      document.getElementById('goldBonusBtn').disabled = gameState.resources.gold < goldCost;
      
      // Ore獲得+
      const oreCost = Math.floor(100 * Math.pow(1.5, gameState.upgrades.oreBonus));
      document.getElementById('oreBonusCost').textContent = t('game.costGold', { n: formatNumber(oreCost) });
      document.getElementById('oreBonusLevel').textContent = gameState.upgrades.oreBonus;
      document.getElementById('oreBonusBtn').disabled = gameState.resources.gold < oreCost;
      
      // クリティカル率+
      const critCost = Math.floor(50 * Math.pow(1.5, gameState.upgrades.critChance));
      document.getElementById('critChanceCost').textContent = t('game.costOre', { n: formatNumber(critCost) });
      document.getElementById('critChanceLevel').textContent = gameState.upgrades.critChance;
      const totalOre = Object.values(gameState.resources.ore).reduce((a, b) => a + b, 0);
      document.getElementById('critChanceBtn').disabled = totalOre < critCost;
    }

    function updateRareWeaponsUI() {
      const weaponsList = document.getElementById('rareWeaponsList');
      weaponsList.innerHTML = '';
      
      Object.entries(RARE_WEAPONS).forEach(([weaponId, weaponData]) => {
        const isUnlocked = gameState.unlockedWeapons.includes(weaponId);
        const card = document.createElement('div');
        card.className = `upgrade-card ${weaponData.rarity}`;
        
        // 必要鉱物の表示
        let requiredOresText = '';
        const requiredOres = Object.entries(weaponData.requiredOres);
        requiredOres.forEach(([oreType, amount]) => {
          const current = gameState.resources.ore[oreType] || 0;
          const hasEnough = current >= amount;
          const oreData = ORE_TYPES[oreType];
        requiredOresText += `<div style="color:${hasEnough ? '#22c55e' : '#ef4444'}; font-size:11px; display:flex; align-items:center;">
          <img src="${oreData.image}" alt="${getOreName(oreType)}" style="width:16px; height:16px; margin-right:4px;" />
          ${getOreName(oreType)}: ${current}/${amount}
        </div>`;
        });
        
        // ステータス表示
        const stats = weaponData.stats;
        let statsText = '';
        if (stats.tapPower) statsText += `${t('stats.tapPower')}+${stats.tapPower} `;
        if (stats.tapPowerPercent) statsText += `${t('stats.tapPowerPercent')}+${stats.tapPowerPercent}% `;
        if (stats.goldBonus) statsText += `${t('stats.goldBonus')}+${stats.goldBonus}% `;
        if (stats.oreBonus) statsText += `${t('stats.oreBonus')}+${stats.oreBonus}% `;
        statsText += `${t('ui.durability')}: ${weaponData.durability}`;
        
        // 必要鉱物が揃っているかチェック
        const canUnlock = requiredOres.every(([oreType, amount]) => 
          (gameState.resources.ore[oreType] || 0) >= amount
        );
        
        card.innerHTML = `
          <div class="upgrade-header">
            <div class="upgrade-name" style="color:${RARITY[weaponData.rarity].color}">${getRareWeaponName(weaponId)}</div>
            <div class="equipment-rarity" style="background:${RARITY[weaponData.rarity].color}20; color:${RARITY[weaponData.rarity].color}; font-size:11px;">
              ${getRarityName(weaponData.rarity)}
            </div>
          </div>
          <div class="upgrade-desc" style="margin-bottom:8px;">${statsText}</div>
          <div style="margin-bottom:8px;">
            <div style="font-size:11px; color:#94a3b8; margin-bottom:4px;">${t('ui.requiredOres')}:</div>
            ${requiredOresText}
          </div>
          ${isUnlocked ? 
            '<div style="color:#22c55e; font-size:12px; margin-bottom:8px;">✓ ' + t('ui.developed') + '</div>' :
            `<button class="btn" ${canUnlock ? '' : 'disabled'} onclick="unlockWeapon('${weaponId}')">${t('ui.unlock')}</button>`
          }
        `;
        weaponsList.appendChild(card);
      });
    }

    function unlockWeapon(weaponId) {
      const weaponData = RARE_WEAPONS[weaponId];
      if (!weaponData) return;
      
      if (gameState.unlockedWeapons.includes(weaponId)) {
        alert(t('game.alreadyDeveloped'));
        return;
      }
      
      // 必要鉱物が揃っているかチェック
      const requiredOres = Object.entries(weaponData.requiredOres);
      const canUnlock = requiredOres.every(([oreType, amount]) => 
        (gameState.resources.ore[oreType] || 0) >= amount
      );
      
      if (!canUnlock) {
        alert(t('game.notEnoughOre'));
        return;
      }
      
      // 確認
      let requiredOresText = '';
      requiredOres.forEach(([oreType, amount]) => {
        requiredOresText += `${getOreName(oreType)}x${amount} `;
      });
      
      if (!confirm(t('game.unlockConfirm', { name: getRareWeaponName(weaponId), ores: requiredOresText }))) {
        return;
      }
      
      // 鉱物を消費
      requiredOres.forEach(([oreType, amount]) => {
        gameState.resources.ore[oreType] -= amount;
      });
      
      // 武器を開発解除
      gameState.unlockedWeapons.push(weaponId);
      
      // 武器をインベントリに追加
      const weapon = {
        id: weaponId + '-' + Date.now(),
        type: 'tool',
        nameKey: weaponData.nameKey,
        rarity: weaponData.rarity,
        durability: weaponData.durability,
        maxDurability: weaponData.maxDurability,
        stats: JSON.parse(JSON.stringify(weaponData.stats))
      };
      
      gameState.inventory.push(weapon);
      
      addLog(t('game.weaponUnlocked', { name: getRareWeaponName(weaponId) }), weaponData.rarity);
      updateUI();
      checkAutoSave();
    }

    // ===== ショップ機能 =====
    function calculateEquipmentPrice(equipment) {
      const rarityMultipliers = {
        common: 1,
        rare: 3,
        epic: 8,
        legendary: 20
      };
      const multiplier = rarityMultipliers[equipment.rarity] || 1;
      
      const stats = equipment.stats || {};
      let statValue = 0;
      statValue += (stats.tapPower || 0) * 10;
      statValue += (stats.tapPowerPercent || 0) * 5;
      statValue += (stats.goldBonus || 0) * 8;
      statValue += (stats.oreBonus || 0) * 8;
      
      // 耐久力も価格に影響
      if (equipment.durability !== undefined && equipment.maxDurability !== undefined) {
        const durabilityRatio = equipment.durability / equipment.maxDurability;
        statValue = Math.floor(statValue * durabilityRatio);
      }
      
      return Math.floor(statValue * multiplier);
    }

    function calculateOrePrice(oreType, quantity) {
      const basePrice = ORE_PRICES[oreType] || 0;
      // 数量に応じた価格（数量が多いほど単価が少し上がる）
      const quantityMultiplier = 1 + (quantity - 1) * 0.1;
      return Math.floor(basePrice * quantity * quantityMultiplier);
    }

    function calculateGemPrice(gem) {
      const gemType = GEM_TYPES[gem.type];
      const gemSize = GEM_SIZES[gem.size];
      if (!gemType || !gemSize) return 0;
      
      return Math.floor(gemType.basePrice * gemSize.multiplier);
    }

    function sellEquipment(equipment) {
      const price = calculateEquipmentPrice(equipment);
      const index = gameState.inventory.findIndex(eq => eq.id === equipment.id);
      if (index >= 0) {
        gameState.resources.gold += price;
        gameState.inventory.splice(index, 1);
        addLog(`<img src="${ASSET_PATHS.coin}" alt="Gold" />${t('game.soldEquipment', { name: getEquipmentDisplayName(equipment), price: formatNumber(price) })}`, equipment.rarity);
        updateUI();
        checkAutoSave();
      }
    }

    function sellOre(oreType, quantity) {
      if (gameState.resources.ore[oreType] < quantity) {
        alert(t('game.notEnoughOre'));
        return;
      }
      
      const price = calculateOrePrice(oreType, quantity);
      gameState.resources.ore[oreType] -= quantity;
      gameState.resources.gold += price;
      const oreData = ORE_TYPES[oreType];
      addLog(`<img src="${oreData.image}" alt="${getOreName(oreType)}" />${t('game.soldOre', { name: getOreName(oreType), n: quantity, price: formatNumber(price) })}`, 'rare');
      updateUI();
      checkAutoSave();
    }

    function sellGem(gem) {
      const price = calculateGemPrice(gem);
      const index = gameState.resources.gems.findIndex(g => g.id === gem.id);
      if (index >= 0) {
        gameState.resources.gold += price;
        gameState.resources.gems.splice(index, 1);
        const gemImage = ASSET_PATHS.gems[gem.type] || ASSET_PATHS.gems.ruby;
        addLog(`<img src="${gemImage}" alt="${getGemName(gem.type)}" />${t('game.soldGem', { size: getGemSizeName(gem.size), name: getGemName(gem.type), price: formatNumber(price) })}`, 'legendary');
        updateUI();
        checkAutoSave();
      }
    }

    function updateShopUI() {
      // 装備リスト
      const equipmentList = document.getElementById('shopEquipmentList');
      equipmentList.innerHTML = '';
      if (gameState.inventory.length === 0) {
        equipmentList.innerHTML = '<div style="color:#666; padding:20px; text-align:center;">' + t('ui.noEquipmentToSell') + '</div>';
      } else {
        const tools = gameState.inventory.filter(eq => eq.type === 'tool');
        if (tools.length === 0) {
          equipmentList.innerHTML = '<div style="color:#666; padding:20px; text-align:center;">' + t('ui.noPickaxeToSell') + '</div>';
        } else {
          tools.forEach(eq => {
            const card = document.createElement('div');
            card.className = `equipment-card ${eq.rarity}`;
            const price = calculateEquipmentPrice(eq);
            const rarity = RARITY[eq.rarity];
            card.innerHTML = `
              <div class="equipment-header">
                <div class="equipment-name">${getEquipmentDisplayName(eq)}</div>
                <div class="equipment-rarity" style="background:${rarity.color}20; color:${rarity.color}">
                  ${getRarityName(eq.rarity)}
                </div>
              </div>
              <div class="equipment-stats" style="margin-bottom:8px;">${t('ui.price')}: ${formatNumber(price)} Gold</div>
              <button class="btn" style="padding:6px; font-size:12px;" onclick="sellEquipmentById('${eq.id}')">${t('ui.sell')}</button>
            `;
            equipmentList.appendChild(card);
          });
        }
      }
      
      // 鉱物リスト
      const oreList = document.getElementById('shopOreList');
      oreList.innerHTML = '';
      const oreTypes = Object.keys(ORE_TYPES);
      oreTypes.forEach(oreType => {
        const quantity = gameState.resources.ore[oreType];
        if (quantity > 0) {
          const card = document.createElement('div');
          card.className = 'equipment-card';
          const price1 = calculateOrePrice(oreType, 1);
          const price10 = calculateOrePrice(oreType, 10);
          const priceAll = calculateOrePrice(oreType, quantity);
          const oreData = ORE_TYPES[oreType];
          card.innerHTML = `
            <div class="equipment-header">
              <div class="equipment-name" style="display:flex; align-items:center;">
                <img src="${oreData.image}" alt="${getOreName(oreType)}" style="width:24px; height:24px; margin-right:6px;" />
                ${getOreName(oreType)}
              </div>
              <div style="font-size:12px; color:#aaa;">${t('ui.owned')}: ${quantity}</div>
            </div>
            <div class="equipment-stats" style="margin-bottom:8px;">
              <div><img src="${ASSET_PATHS.coin}" alt="Gold" style="width:14px; height:14px; vertical-align:middle;" /> ${t('ui.per1')}: ${formatNumber(price1)} Gold</div>
              <div><img src="${ASSET_PATHS.coin}" alt="Gold" style="width:14px; height:14px; vertical-align:middle;" /> ${t('ui.per10')}: ${formatNumber(price10)} Gold</div>
              <div><img src="${ASSET_PATHS.coin}" alt="Gold" style="width:14px; height:14px; vertical-align:middle;" /> ${t('ui.all')}: ${formatNumber(priceAll)} Gold</div>
            </div>
            <div style="display:flex; gap:4px;">
              <button class="btn" style="flex:1; padding:6px; font-size:11px;" onclick="sellOreByType('${oreType}', 1)">${t('ui.sell1')}</button>
              <button class="btn" style="flex:1; padding:6px; font-size:11px;" onclick="sellOreByType('${oreType}', 10)">${t('ui.sell10')}</button>
              <button class="btn" style="flex:1; padding:6px; font-size:11px;" onclick="sellOreByType('${oreType}', ${quantity})">${t('ui.sellAll')}</button>
            </div>
          `;
          oreList.appendChild(card);
        }
      });
      if (oreList.innerHTML === '') {
        oreList.innerHTML = '<div style="color:#666; padding:20px; text-align:center;">' + t('ui.noOreToSell') + '</div>';
      }
      
      // 宝石リスト
      const gemList = document.getElementById('shopGemList');
      gemList.innerHTML = '';
      if (!Array.isArray(gameState.resources.gems) || gameState.resources.gems.length === 0) {
        gemList.innerHTML = '<div style="color:#666; padding:20px; text-align:center;">' + t('ui.noGemsToExchange') + '</div>';
      } else {
        gameState.resources.gems.forEach(gem => {
          const card = document.createElement('div');
          card.className = 'equipment-card legendary';
          const price = calculateGemPrice(gem);
          const gemImage = ASSET_PATHS.gems[gem.type] || ASSET_PATHS.gems.ruby;
          card.innerHTML = `
            <div class="equipment-header">
              <div class="equipment-name" style="display:flex; align-items:center;">
                <img src="${gemImage}" alt="${getGemName(gem.type)}" style="width:24px; height:24px; margin-right:6px;" />
                ${getGemSizeName(gem.size)} ${getGemName(gem.type)}
              </div>
            </div>
            <div class="equipment-stats" style="margin-bottom:8px;">
              <img src="${ASSET_PATHS.coin}" alt="Gold" style="width:14px; height:14px; vertical-align:middle;" /> ${t('ui.price')}: ${formatNumber(price)} Gold
            </div>
            <button class="btn" style="padding:6px; font-size:12px;" onclick="sellGemById('${gem.id}')">${t('ui.exchange')}</button>
          `;
          gemList.appendChild(card);
        });
      }
    }

    function addLog(message, type = '') {
      const logPanel = document.getElementById('mineLog');
      const entry = document.createElement('div');
      entry.className = 'log-entry' + (type ? ' ' + type : '');
      entry.innerHTML = message; // innerHTMLに変更して画像を表示可能に
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
      
      // ログが多すぎたら古いのを削除
      while (logPanel.children.length > 20) {
        logPanel.removeChild(logPanel.firstChild);
      }
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return Math.floor(num).toString();
    }

    // ===== セーブ/ロード =====
    function saveGame() {
      try {
        const saveData = {
          depth: gameState.depth,
          currentBlockHp: gameState.currentBlockHp,
          currentBlockMaxHp: gameState.currentBlockMaxHp,
          resources: gameState.resources,
          tool: gameState.tool,
          inventory: gameState.inventory,
          upgrades: gameState.upgrades,
          unlockedWeapons: gameState.unlockedWeapons
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
        gameState.lastSaveTime = Date.now();
      } catch (e) {
        console.error('セーブ失敗:', e);
      }
    }

    function loadGame() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          gameState = { ...gameState, ...data };
          
          // 旧バージョンのセーブデータとの互換性
          if (!Array.isArray(gameState.resources.gems)) {
            gameState.resources.gems = [];
          }
          if (!Array.isArray(gameState.unlockedWeapons)) {
            gameState.unlockedWeapons = [];
          }
          
          // 装備中のツルハシに耐久力がない場合は追加
          if (gameState.tool.equipped && gameState.tool.equipped.durability === undefined) {
            gameState.tool.equipped.durability = gameState.tool.equipped.maxDurability || 100;
            if (!gameState.tool.equipped.maxDurability) {
              gameState.tool.equipped.maxDurability = 100;
            }
          }
          
          // インベントリの装備にも耐久力を追加
          gameState.inventory.forEach(eq => {
            if (eq.type === 'tool' && eq.durability === undefined) {
              eq.durability = eq.maxDurability || 100;
              if (!eq.maxDurability) {
                eq.maxDurability = 100;
              }
            }
          });
          
          // ツルハシがない場合は基本ツルハシを装備
          if (!gameState.tool.equipped) {
            const basePickaxe = createBasePickaxe();
            gameState.tool.equipped = basePickaxe;
          }
          
          updateUI();
          addLog(t('game.gameLoaded'), 'rare');
        }
      } catch (e) {
        console.error('ロード失敗:', e);
      }
    }

    function checkAutoSave() {
      const now = Date.now();
      if (now - gameState.lastSaveTime >= AUTO_SAVE_INTERVAL) {
        saveGame();
      }
    }

    function resetGame() {
      if (confirm(t('game.resetConfirm'))) {
        localStorage.removeItem(STORAGE_KEY);
        initGame();
        addLog(t('game.gameReset'));
      }
    }

    // ===== i18n UI refresh =====
    function refreshTitleScreen() {
      document.getElementById('titleHeading').textContent = t('ui.title');
      document.getElementById('btnNewGame').textContent = t('ui.newGame');
      document.getElementById('btnContinue').textContent = t('ui.continue');
      document.getElementById('titleLangLabel').textContent = t('ui.language');
      var sel = document.getElementById('titleLangSelect');
      if (sel) {
        sel.querySelector('option[value="en"]').textContent = t('ui.langEn');
        sel.querySelector('option[value="es"]').textContent = t('ui.langEs');
        sel.querySelector('option[value="da"]').textContent = t('ui.langDa');
        sel.querySelector('option[value="ja"]').textContent = t('ui.langJa');
      }
      document.getElementById('btnContinue').disabled = !hasSave();
    }

    function hasSave() {
      try {
        var saved = localStorage.getItem(STORAGE_KEY);
        return saved && saved.length > 0;
      } catch (e) { return false; }
    }

    function showTitleScreen() {
      document.getElementById('titleScreen').style.display = 'flex';
      document.getElementById('gameScreen').classList.remove('active');
    }

    function showGameScreen() {
      document.getElementById('titleScreen').style.display = 'none';
      document.getElementById('gameScreen').classList.add('active');
    }

    function refreshUIText() {
      var locale = i18n.getLocale();
      document.documentElement.lang = locale === 'ja' ? 'ja' : locale === 'es' ? 'es' : locale === 'da' ? 'da' : 'en';
      document.title = t('ui.pageTitle');
      document.getElementById('gameTitle').textContent = t('ui.title');
      document.getElementById('statGold').textContent = t('ui.gold');
      document.getElementById('statOre').textContent = t('ui.ore');
      document.getElementById('statGems').textContent = t('ui.gems');
      document.getElementById('tabMine').textContent = t('ui.tabMine');
      document.getElementById('tabEquipment').textContent = t('ui.tabEquipment');
      document.getElementById('tabUpgrade').textContent = t('ui.tabUpgrade');
      document.getElementById('tabShop').textContent = t('ui.tabShop');
      document.getElementById('depthLabel').textContent = t('ui.depth');
      document.getElementById('tapPowerLabel').textContent = t('ui.tapPower');
      document.getElementById('toolDurabilityLabel').textContent = t('ui.pickaxeDurability');
      document.getElementById('mineButton').textContent = t('ui.mineBtn');
      document.getElementById('sectionEquipped').textContent = t('ui.equipped');
      document.getElementById('sectionInventory').textContent = t('ui.inventory');
      document.getElementById('upgradeToolName').textContent = t('ui.toolUpgrade');
      document.getElementById('upgradeToolDesc').textContent = t('upgrade.tapPowerDesc');
      document.getElementById('upgradeGoldName').textContent = t('ui.goldBonus');
      document.getElementById('upgradeGoldDesc').textContent = t('upgrade.goldBonusDesc');
      document.getElementById('upgradeOreName').textContent = t('ui.oreBonus');
      document.getElementById('upgradeOreDesc').textContent = t('upgrade.oreBonusDesc');
      document.getElementById('upgradeCritName').textContent = t('ui.critChance');
      document.getElementById('upgradeCritDesc').textContent = t('upgrade.critChanceDesc');
      document.querySelectorAll('[id^="levelLabel"]').forEach(el => { el.textContent = t('ui.level'); });
      document.getElementById('toolUpgradeBtn').textContent = t('ui.upgradeBtn');
      document.getElementById('goldBonusBtn').textContent = t('ui.upgradeBtn');
      document.getElementById('oreBonusBtn').textContent = t('ui.upgradeBtn');
      document.getElementById('critChanceBtn').textContent = t('ui.upgradeBtn');
      document.getElementById('rareWeaponsTitle').textContent = t('ui.rareWeapons');
      document.getElementById('resetBtn').textContent = t('ui.reset');
      document.getElementById('shopEquipmentTitle').textContent = t('ui.sellEquipment');
      document.getElementById('shopOreTitle').textContent = t('ui.sellOre');
      document.getElementById('shopGemTitle').textContent = t('ui.exchangeGems');
      updateUI();
    }

    // ===== 初期化 =====
    function startGame(isNewGame) {
      if (isNewGame) {
        initGame();
      } else {
        loadGame();
        if (!gameState.depth) initGame();
        else updateUI();
      }
      setInterval(checkAutoSave, AUTO_SAVE_INTERVAL);
      window.addEventListener('beforeunload', saveGame);
    }

    function initWithI18n() {
      i18n.init();
      var locale = i18n.getLocale();
      Promise.all([
        i18n.loadLocale('en'),
        i18n.loadLocale('es').catch(function() { return {}; }),
        i18n.loadLocale('da').catch(function() { return {}; }),
        i18n.loadLocale('ja').catch(function() { return {}; })
      ]).then(function() {
        document.getElementById('titleLangSelect').value = locale;
        refreshTitleScreen();
        document.getElementById('btnNewGame').addEventListener('click', function() {
          showGameScreen();
          refreshUIText();
          startGame(true);
        });
        document.getElementById('btnContinue').addEventListener('click', function() {
          if (!hasSave()) return;
          showGameScreen();
          refreshUIText();
          startGame(false);
        });
        document.getElementById('titleLangSelect').addEventListener('change', function() {
          var newLocale = this.value;
          i18n.setLocale(newLocale);
          refreshTitleScreen();
        });
      }).catch(function(err) {
        console.error('Failed to load locales:', err);
        refreshTitleScreen();
      });
    }

    // ショップ用のグローバル関数
    function sellEquipmentById(id) {
      // idを数値に変換（文字列の場合があるため）
      const idNum = typeof id === 'string' ? parseFloat(id) : id;
      const equipment = gameState.inventory.find(eq => eq.id === idNum || eq.id === id);
      if (equipment) {
        if (confirm(t('game.sellEquipmentConfirm', { name: getEquipmentDisplayName(equipment), price: formatNumber(calculateEquipmentPrice(equipment)) }))) {
          sellEquipment(equipment);
        }
      } else {
        console.error('Equipment not found:', id, gameState.inventory);
      }
    }

    function sellOreByType(oreType, quantity) {
      if (gameState.resources.ore[oreType] < quantity) {
        alert(t('game.notEnoughOre'));
        return;
      }
      if (confirm(t('game.sellOreConfirm', { name: getOreName(oreType), n: quantity, price: formatNumber(calculateOrePrice(oreType, quantity)) }))) {
        sellOre(oreType, quantity);
      }
    }

    function sellGemById(id) {
      // idを数値に変換（文字列の場合があるため）
      const idNum = typeof id === 'string' ? parseFloat(id) : id;
      const gem = gameState.resources.gems.find(g => g.id === idNum || g.id === id);
      if (gem) {
        if (confirm(t('game.sellGemConfirm', { size: getGemSizeName(gem.size), name: getGemName(gem.type), price: formatNumber(calculateGemPrice(gem)) }))) {
          sellGem(gem);
        }
      } else {
        console.error('Gem not found:', id, gameState.resources.gems);
      }
    }

    // グローバル関数（HTMLから呼び出すため）
    window.mine = mine;
    window.upgradeTool = upgradeTool;
    window.upgradeGoldBonus = upgradeGoldBonus;
    window.upgradeOreBonus = upgradeOreBonus;
    window.upgradeCritChance = upgradeCritChance;
    window.unequipTool = unequipTool;
    window.switchTab = switchTab;
    window.resetGame = resetGame;
    window.sellEquipmentById = sellEquipmentById;
    window.sellOreByType = sellOreByType;
    window.sellGemById = sellGemById;
    window.unlockWeapon = unlockWeapon;

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initWithI18n);
    } else {
      initWithI18n();
    }
  </script>
</body>
</html>
