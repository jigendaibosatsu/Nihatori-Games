<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>カートレース – Nihatori Games</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; touch-action: none; -webkit-tap-highlight-color: transparent; }
    body.game-page {
      padding-top: 48px;
      background: linear-gradient(180deg, #87CEEB 0%, #98D98E 60%, #7CB342 100%);
      font-family: "MS PGothic", "Yu Gothic", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #1b5e20;
    }
    .kart-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 520px;
      padding: 8px;
      min-height: 0;
    }
    .kart-title { font-size: 1rem; font-weight: bold; margin-bottom: 4px; flex-shrink: 0; }
    .kart-hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 4px;
      font-size: 12px;
      flex-shrink: 0;
    }
    .kart-canvas-wrap {
      width: 100%;
      flex: 1;
      min-height: 0;
      max-height: min(55dvh, 65vh);
      background: #2d5016;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.35);
      border: 3px solid #1b5e20;
    }
    #kartCanvas {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .kart-controls {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
    }
    .kart-btn {
      width: 64px;
      height: 64px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(180deg, #fff 0%, #e0e0e0 100%);
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      font-size: 20px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      font-weight: bold;
      color: #333;
    }
    .kart-btn:active { transform: scale(0.92); box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
    .kart-btn.gas {
      width: 80px;
      height: 80px;
      background: linear-gradient(180deg, #ff5722 0%, #e64a19 100%);
      color: #fff;
      font-size: 14px;
    }
    .kart-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      padding: 48px 16px 0;
    }
    .kart-overlay.visible { display: flex; }
    .kart-overlay-box {
      background: linear-gradient(180deg, #fff 0%, #f5f5f5 100%);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      max-width: 320px;
      border: 3px solid #2e7d32;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .kart-overlay-box h2 { margin-bottom: 12px; font-size: 1.35rem; color: #1b5e20; }
    .kart-overlay-box p { margin-bottom: 16px; color: #333; font-size: 14px; }
    .kart-overlay-box .btn {
      display: inline-block;
      padding: 12px 28px;
      background: linear-gradient(180deg, #43a047, #2e7d32);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      -webkit-tap-highlight-color: transparent;
    }
    .kart-back { display: inline-block; margin-top: 12px; color: #2e7d32; font-size: 14px; text-decoration: none; }
    .kart-back:hover { text-decoration: underline; }
  </style>
</head>
<body class="game-page">
  <div id="site-header"></div>

  <div class="kart-wrap">
    <h1 class="kart-title">カートレース</h1>
    <div class="kart-hud">
      <span id="kartLap">1 / 3 周</span>
      <span id="kartPos">順位: --</span>
    </div>
    <div class="kart-canvas-wrap">
      <canvas id="kartCanvas" width="480" height="320"></canvas>
    </div>
    <div class="kart-controls">
      <button type="button" class="kart-btn" id="btnLeft" aria-label="左">←</button>
      <button type="button" class="kart-btn gas" id="btnGas" aria-label="アクセル">GO</button>
      <button type="button" class="kart-btn" id="btnRight" aria-label="右">→</button>
    </div>
  </div>

  <div class="kart-overlay" id="overlay">
    <div class="kart-overlay-box">
      <h2 id="overlayTitle">スタート</h2>
      <p id="overlayMsg">GO ボタンでアクセル！ 左右で曲がれます。</p>
      <button type="button" class="btn" id="btnStart">スタート</button>
      <a href="/index.html" class="kart-back">← トップへ戻る</a>
    </div>
  </div>

  <div class="kart-overlay" id="overlayFinish">
    <div class="kart-overlay-box">
      <h2 id="finishTitle">ゴール！</h2>
      <p id="finishMsg"></p>
      <button type="button" class="btn" id="btnRetry">もう一度</button>
      <a href="/index.html" class="kart-back">← トップへ戻る</a>
    </div>
  </div>

  <script src="/assets/header.js"></script>
  <script>
(function () {
  var canvas = document.getElementById('kartCanvas');
  var ctx = canvas.getContext('2d');
  var W = 480, H = 320;
  var cx = W / 2, cy = H / 2;
  var trackOuterRx = 200, trackOuterRy = 130;
  var trackWidth = 48;
  var trackInnerRx = trackOuterRx - trackWidth;
  var trackInnerRy = trackOuterRy - trackWidth;

  var TOTAL_LAPS = 3;
  var finishY = cy - trackOuterRy + 8;
  var finishHalfW = 25;

  var KART_COLORS = ['#E53935', '#1E88E5', '#43A047', '#FB8C00'];
  var NUM_AI = 3;

  function isOnTrack(px, py) {
    var dx = (px - cx) / trackOuterRx;
    var dy = (py - cy) / trackOuterRy;
    var outer = dx * dx + dy * dy <= 1;
    var ix = (px - cx) / trackInnerRx;
    var iy = (py - cy) / trackInnerRy;
    var inner = ix * ix + iy * iy < 1;
    return outer && inner;
  }

  function getTrackAngle(px, py) {
    return Math.atan2(py - cy, px - cx);
  }

  function getProgressAngle(px, py) {
    var a = Math.atan2(py - cy, px - cx);
    return (a + Math.PI) / (2 * Math.PI);
  }

  function angleToPoint(angle) {
    var r = (trackOuterRx + trackInnerRx) / 2;
    var ry = (trackOuterRy + trackInnerRy) / 2;
    return { x: cx + r * Math.cos(angle), y: cy + ry * Math.sin(angle) };
  }

  var karts = [];
  var state = {
    running: false,
    countdown: 0,
    playerLap: 0,
    playerLastCross: -1,
    finished: [],
    positions: []
  };

  function createKart(isPlayer, color, index) {
    var startAngle = -Math.PI / 2;
    var p = angleToPoint(startAngle);
    return {
      x: p.x,
      y: p.y,
      prevY: p.y,
      angle: Math.PI / 2,
      speed: 0,
      maxSpeed: isPlayer ? 4.2 : 3.6,
      accel: 0.18,
      friction: 0.96,
      turnSpeed: 0.06,
      grassFriction: 0.92,
      isPlayer: isPlayer,
      color: color,
      lap: 0,
      lastCross: -1,
      progress: 0,
      aiAngle: startAngle,
      finished: false
    };
  }

  function resetKarts() {
    karts = [];
    karts.push(createKart(true, '#E53935', 0));
    for (var i = 0; i < NUM_AI; i++) {
      var a = (i + 1) * 0.08;
      var p = angleToPoint(-Math.PI / 2 - a);
      var k = createKart(false, KART_COLORS[i + 1], i + 1);
      k.x = p.x;
      k.y = p.y;
      k.aiAngle = -Math.PI / 2 - a;
      karts.push(k);
    }
    state.playerLap = 0;
    state.playerLastCross = -1;
    state.finished = [];
    state.positions = [];
  }

  function crossFinishLine(kart, isPlayer) {
    if (Math.abs(kart.x - cx) > finishHalfW) return;
    var crossed = kart.prevY > finishY && kart.y <= finishY;
    if (!crossed) return;
    if (kart.lastCross === state.countdown) return;
    kart.lastCross = state.countdown;
    kart.lap++;
    if (kart.lap >= TOTAL_LAPS) {
      kart.finished = true;
      state.finished.push(isPlayer ? 'player' : kart);
    }
  }

  function updatePositions() {
    var list = [];
    for (var i = 0; i < karts.length; i++) {
      var k = karts[i];
      if (k.finished) {
        var order = state.finished.indexOf(k.isPlayer ? 'player' : k) + 1;
        list.push({ kart: k, score: 1000 * k.lap + order, finished: true, order: order });
      } else {
        var prog = k.lap * 1000 + k.progress * 1000;
        list.push({ kart: k, score: prog, finished: false });
      }
    }
    list.sort(function (a, b) {
      if (a.finished && b.finished) return a.order - b.order;
      if (a.finished) return -1;
      if (b.finished) return 1;
      return b.score - a.score;
    });
    state.positions = list;
  }

  function getPlayerRank() {
    var playerKart = karts[0];
    for (var i = 0; i < state.positions.length; i++) {
      if (state.positions[i].kart === playerKart) return i + 1;
    }
    return 1;
  }

  function updateKart(kart, dt) {
    if (kart.finished) return;
    var onTrack = isOnTrack(kart.x, kart.y);
    var friction = onTrack ? kart.friction : kart.grassFriction;
    if (kart.isPlayer && state.running) {
      var acc = 0;
      if (keys.up) acc += kart.accel;
      if (keys.down) acc -= kart.accel * 0.8;
      kart.speed += acc;
      if (keys.left) kart.angle -= kart.turnSpeed * (1 + Math.abs(kart.speed) * 0.05);
      if (keys.right) kart.angle += kart.turnSpeed * (1 + Math.abs(kart.speed) * 0.05);
    } else if (!kart.isPlayer) {
      kart.speed += kart.accel * 0.7;
      kart.aiAngle += 0.015 + kart.speed * 0.003;
      if (kart.aiAngle > Math.PI) kart.aiAngle -= 2 * Math.PI;
      var target = angleToPoint(kart.aiAngle);
      var dx = target.x - kart.x, dy = target.y - kart.y;
      var wantAngle = Math.atan2(dy, dx) + Math.PI / 2;
      var da = wantAngle - kart.angle;
      while (da > Math.PI) da -= 2 * Math.PI;
      while (da < -Math.PI) da += 2 * Math.PI;
      kart.angle += da * 0.1;
    }
    kart.speed *= friction;
    if (kart.speed > kart.maxSpeed) kart.speed = kart.maxSpeed;
    if (kart.speed < -kart.maxSpeed * 0.5) kart.speed = -kart.maxSpeed * 0.5;
    kart.prevY = kart.y;
    var vx = Math.sin(kart.angle) * kart.speed;
    var vy = -Math.cos(kart.angle) * kart.speed;
    kart.x += vx;
    kart.y += vy;
    kart.progress = getProgressAngle(kart.x, kart.y);
    crossFinishLine(kart, kart.isPlayer);
  }

  var keys = { up: false, down: false, left: false, right: false };

  function drawTrack() {
    ctx.fillStyle = '#5D4037';
    ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = '#8D6E63';
    ctx.beginPath();
    ctx.ellipse(cx, cy, trackOuterRx, trackOuterRy, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#2d5016';
    ctx.beginPath();
    ctx.ellipse(cx, cy, trackInnerRx, trackInnerRy, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.ellipse(cx, cy, trackOuterRx, trackOuterRy, 0, 0, Math.PI * 2);
    ctx.stroke();
    ctx.beginPath();
    ctx.ellipse(cx, cy, trackInnerRx, trackInnerRy, 0, 0, Math.PI * 2);
    ctx.stroke();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(cx - finishHalfW, finishY);
    ctx.lineTo(cx + finishHalfW, finishY);
    ctx.stroke();
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('GOAL', cx, finishY - 6);
  }

  function drawKart(kart) {
    ctx.save();
    ctx.translate(kart.x, kart.y);
    ctx.rotate(kart.angle);
    var w = 14, h = 22;
    ctx.fillStyle = kart.color;
    ctx.fillRect(-w / 2, -h / 2, w, h);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 1.5;
    ctx.strokeRect(-w / 2, -h / 2, w, h);
    ctx.fillStyle = '#fff';
    ctx.fillRect(2, -6, 4, 6);
    ctx.restore();
  }

  function draw() {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    drawTrack();
    for (var i = 0; i < karts.length; i++) drawKart(karts[i]);
  }

  function gameLoop() {
    if (!state.running) {
      draw();
      requestAnimationFrame(gameLoop);
      return;
    }
    state.countdown++;
    var dt = 1;
    for (var i = 0; i < karts.length; i++) updateKart(karts[i], dt);
    updatePositions();

    var playerKart = karts[0];
    document.getElementById('kartLap').textContent = (playerKart.lap + 1) + ' / ' + TOTAL_LAPS + ' 周';
    document.getElementById('kartPos').textContent = '順位: ' + getPlayerRank() + ' 位';

    if (playerKart.finished) {
      state.running = false;
      document.getElementById('finishTitle').textContent = 'ゴール！';
      var rank = getPlayerRank();
      var msg = rank === 1 ? '1位でゴール！ おめでとう！' : rank + '位でゴール！';
      document.getElementById('finishMsg').textContent = msg;
      document.getElementById('overlayFinish').classList.add('visible');
      draw();
      return;
    }

    draw();
    requestAnimationFrame(gameLoop);
  }

  document.addEventListener('keydown', function (e) {
    if (e.key === 'ArrowUp') { keys.up = true; e.preventDefault(); }
    if (e.key === 'ArrowDown') { keys.down = true; e.preventDefault(); }
    if (e.key === 'ArrowLeft') { keys.left = true; e.preventDefault(); }
    if (e.key === 'ArrowRight') { keys.right = true; e.preventDefault(); }
  });
  document.addEventListener('keyup', function (e) {
    if (e.key === 'ArrowUp') keys.up = false;
    if (e.key === 'ArrowDown') keys.down = false;
    if (e.key === 'ArrowLeft') keys.left = false;
    if (e.key === 'ArrowRight') keys.right = false;
  });

  document.getElementById('btnGas').addEventListener('mousedown', function () { keys.up = true; });
  document.getElementById('btnGas').addEventListener('mouseup', function () { keys.up = false; });
  document.getElementById('btnGas').addEventListener('mouseleave', function () { keys.up = false; });
  document.getElementById('btnGas').addEventListener('touchstart', function (e) { e.preventDefault(); keys.up = true; }, { passive: false });
  document.getElementById('btnGas').addEventListener('touchend', function (e) { e.preventDefault(); keys.up = false; }, { passive: false });
  document.getElementById('btnLeft').addEventListener('mousedown', function () { keys.left = true; });
  document.getElementById('btnLeft').addEventListener('mouseup', function () { keys.left = false; });
  document.getElementById('btnLeft').addEventListener('mouseleave', function () { keys.left = false; });
  document.getElementById('btnLeft').addEventListener('touchstart', function (e) { e.preventDefault(); keys.left = true; }, { passive: false });
  document.getElementById('btnLeft').addEventListener('touchend', function (e) { e.preventDefault(); keys.left = false; }, { passive: false });
  document.getElementById('btnRight').addEventListener('mousedown', function () { keys.right = true; });
  document.getElementById('btnRight').addEventListener('mouseup', function () { keys.right = false; });
  document.getElementById('btnRight').addEventListener('mouseleave', function () { keys.right = false; });
  document.getElementById('btnRight').addEventListener('touchstart', function (e) { e.preventDefault(); keys.right = true; }, { passive: false });
  document.getElementById('btnRight').addEventListener('touchend', function (e) { e.preventDefault(); keys.right = false; }, { passive: false });

  document.getElementById('btnStart').addEventListener('click', function () {
    document.getElementById('overlay').classList.remove('visible');
    resetKarts();
    state.running = true;
  });

  document.getElementById('btnRetry').addEventListener('click', function () {
    document.getElementById('overlayFinish').classList.remove('visible');
    resetKarts();
    state.running = true;
  });

  resetKarts();
  document.getElementById('overlay').classList.add('visible');
  gameLoop();
})();
  </script>
</body>
</html>
