<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>ã‚¦ãƒ¼ãƒ‘ãƒ¼ãƒ«ãƒ¼ãƒ‘ãƒ¼ã‚·ãƒ§ãƒƒãƒ— â€“ Nihatori Games</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body.game-page {
      padding-top: 48px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: radial-gradient(circle at top, #e0f2fe 0%, #e0f7fa 40%, #ecfdf5 100%);
      font-family: "MS PGothic", "Yu Gothic", sans-serif;
      color: #064e3b;
    }
    .ax-wrap {
      width: 100%;
      max-width: 440px;
      padding: 8px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .ax-title {
      font-size: 1rem;
      text-align: center;
      font-weight: bold;
      color: #0ea5e9;
    }
    .ax-sub {
      font-size: 10px;
      text-align: center;
      color: #0f172a;
      margin-bottom: 2px;
      line-height: 1.3;
    }
    .ax-panel {
      background: rgba(255,255,255,0.96);
      border-radius: 10px;
      border: 2px solid #bae6fd;
      padding: 6px 8px;
      box-shadow: 0 4px 12px rgba(56,189,248,0.12);
    }
    .ax-status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      margin-bottom: 2px;
    }
    .ax-money { font-weight: bold; color: #047857; }
    .ax-day { color: #475569; }
    .ax-bars-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 4px;
    }
    .ax-bar-wrap { flex: 1; min-width: 0; }
    .ax-bar-label { font-size: 10px; color: #475569; }
    .ax-bar {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin: 1px 0 2px;
    }
    .ax-bar-fill {
      position: absolute;
      inset: 0;
      width: 0%;
      border-radius: inherit;
      transition: width 0.25s;
    }
    .ax-bar-fill.water { background: linear-gradient(90deg, #38bdf8, #0ea5e9); }
    .ax-bar-fill.clean { background: linear-gradient(90deg, #38bdf8, #0ea5e9); }
    .ax-bar-fill.food { background: linear-gradient(90deg, #4ade80, #22c55e); }
    .ax-bar-fill.reputation { background: linear-gradient(90deg, #fbbf24, #f97316); }
    .ax-tanks {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 4px;
      margin-top: 2px;
    }
    .ax-tank {
      border-radius: 8px;
      border: 1px solid #bfdbfe;
      padding: 3px 5px;
      background: linear-gradient(180deg, #e0f2fe, #f0f9ff);
      font-size: 10px;
      position: relative;
    }
    .ax-tank-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }
    .ax-tank-name { font-weight: bold; color: #0f172a; }
    .ax-tank-tag {
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 999px;
      background: #ecfeff;
      border: 1px solid #7dd3fc;
      color: #0369a1;
    }
    .ax-tank-body {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 2px;
    }
    .ax-tank-lines { line-height: 1.4; }
    @keyframes ax-float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    .ax-axolotl-img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-left: auto;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .ax-axolotl-img.alive {
      animation: ax-float 1.2s ease-in-out infinite;
    }
    .ax-axolotl-img.ax-shade-light {
      filter: brightness(1.18);
    }
    .ax-axolotl-img.ax-shade-dark {
      filter: brightness(0.82);
    }
    .ax-tank-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: #475569;
    }
    .ax-tank-sell {
      padding: 2px 8px;
      font-size: 10px;
      border-radius: 6px;
      border: 1px solid #f97316;
      background: linear-gradient(180deg, #facc15, #f97316);
      color: #451a03;
      cursor: pointer;
      font-weight: bold;
    }
    .ax-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
    }
    .ax-btn {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid transparent;
      font-size: 11px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 44px;
    }
    .ax-btn span.label { display: block; line-height: 1.2; word-break: keep-all; }
    .ax-btn span.note { display: none; }
    .ax-btn.feed {
      background: linear-gradient(180deg, #22c55e, #16a34a);
      border-color: #4ade80;
      color: #f0fdf4;
    }
    .ax-btn.feed-bloodworm {
      background: linear-gradient(180deg, #dc2626, #b91c1c);
      border-color: #f87171;
      color: #fef2f2;
    }
    .ax-btn.feed-earthworm {
      background: linear-gradient(180deg, #65a30d, #4d7c0f);
      border-color: #84cc16;
      color: #f7fee7;
    }
    .ax-btn.clean {
      background: linear-gradient(180deg, #38bdf8, #0ea5e9);
      border-color: #7dd3fc;
      color: #ecfeff;
    }
    .ax-btn.breed {
      background: linear-gradient(180deg, #f472b6, #ec4899);
      border-color: #f9a8d4;
      color: #fdf2f8;
    }
    .ax-btn.treat {
      background: linear-gradient(180deg, #a78bfa, #7c3aed);
      border-color: #c4b5fd;
      color: #f5f3ff;
    }
    .ax-btn.sell {
      background: linear-gradient(180deg, #facc15, #f97316);
      border-color: #fed7aa;
      color: #451a03;
    }
    .ax-btn.day {
      background: linear-gradient(180deg, #64748b, #475569);
      border-color: #94a3b8;
      color: #f1f5f9;
    }
    .ax-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .ax-log {
      flex: 1;
      min-height: 48px;
      max-height: 70px;
      padding: 5px 8px;
      border-radius: 6px;
      border: 1px solid #bae6fd;
      background: rgba(191,219,254,0.25);
      font-size: 10px;
      line-height: 1.4;
      white-space: pre-line;
      overflow-y: auto;
      color: #0f172a;
    }
    .ax-back {
      display: inline-block;
      margin-top: 4px;
      font-size: 11px;
      color: #0369a1;
      text-decoration: none;
    }
    .ax-overlay {
      position: fixed;
      inset: 0;
      padding: 48px 16px 16px;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .ax-overlay.visible { display: flex; }
    .ax-overlay-box {
      background: linear-gradient(180deg, #fdf2f8, #e0f2fe);
      border-radius: 16px;
      border: 4px solid #f472b6;
      padding: 20px;
      max-width: 340px;
      text-align: center;
      box-shadow: 0 18px 35px rgba(0,0,0,0.25);
    }
    .ax-overlay-box h2 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: #be123c;
    }
    .ax-overlay-box p {
      font-size: 13px;
      margin-bottom: 8px;
      color: #111827;
      line-height: 1.6;
    }
    .ax-overlay-box .btn {
      display: inline-block;
      margin-top: 10px;
      padding: 9px 18px;
      border-radius: 999px;
      border: 2px solid #f472b6;
      background: linear-gradient(180deg, #fb7185, #ec4899);
      color: #fdf2f8;
      font-size: 14px;
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
    }
    .ax-buy-type-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      border-radius: 10px;
      border: 2px solid #bae6fd;
      background: linear-gradient(180deg, #e0f2fe, #f0f9ff);
      cursor: pointer;
      font-size: 11px;
      color: #0f172a;
    }
    .ax-buy-type-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .ax-buy-type-img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      image-rendering: pixelated;
      margin-bottom: 4px;
    }
    .ax-buy-type-name { font-weight: bold; }
    .ax-buy-type-price { font-size: 10px; color: #047857; }
    .ax-buy-tabs { }
    .ax-buy-tab {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 8px;
      border: 2px solid #bae6fd;
      background: #e0f2fe;
      color: #0369a1;
      cursor: pointer;
      font-weight: bold;
    }
    .ax-buy-tab:hover { background: #bae6fd; }
    .ax-buy-tab.active {
      background: linear-gradient(180deg, #0ea5e9, #0284c7);
      border-color: #0ea5e9;
      color: #fff;
    }
  </style>
</head>
<body class="game-page">
  <div id="site-header"></div>

  <div class="ax-wrap">
    <h1 class="ax-title">ã‚¦ãƒ¼ãƒ‘ãƒ¼ãƒ«ãƒ¼ãƒ‘ãƒ¼ã‚·ãƒ§ãƒƒãƒ—</h1>
    <p class="ax-sub">æ°´è³ªãƒ»ã‚¨ã‚µãƒ»ç¹æ®–ã®ãƒãƒ©ãƒ³ã‚¹ã§ãŠåº—ã‚’ç¶šã‘ã‚ˆã†ã€‚</p>

    <div class="ax-panel">
      <div class="ax-status-row">
        <span class="ax-day" id="axDay">1æœˆç›®</span>
        <span class="ax-money" id="axMoney">Â¥50,000</span>
      </div>
      <div class="ax-bars-row">
        <div class="ax-bar-wrap">
          <div class="ax-bar-label">æ°´è³ª</div>
          <div class="ax-bar"><div class="ax-bar-fill clean" id="axCleanBar"></div></div>
        </div>
        <div class="ax-bar-wrap">
          <div class="ax-bar-label">è©•åˆ¤</div>
          <div class="ax-bar"><div class="ax-bar-fill reputation" id="axRepBar"></div></div>
        </div>
      </div>
      <div class="ax-tanks" id="axTanks"></div>
    </div>

    <div class="ax-panel">
      <div class="ax-actions">
        <button type="button" class="ax-btn day" id="btnNextMonth">
          <span class="label">æœˆã‚’é€²ã‚ã‚‹</span>
        </button>
        <button type="button" class="ax-btn feed" id="btnFeedArtificial">
          <span class="label">äººå·¥é£¼æ–™ Â¥1,500</span>
        </button>
        <button type="button" class="ax-btn feed-bloodworm" id="btnFeedBloodworm">
          <span class="label">ã‚¢ã‚«ãƒ ã‚· Â¥500</span>
        </button>
        <button type="button" class="ax-btn feed-earthworm" id="btnFeedEarthworm">
          <span class="label">ãƒŸãƒŸã‚º Â¥2,500</span>
        </button>
        <button type="button" class="ax-btn clean" id="btnClean">
          <span class="label">æ°´ã‹ãˆ Â¥1,000</span>
        </button>
        <button type="button" class="ax-btn breed" id="btnBreed">
          <span class="label">ç¹æ®–</span>
        </button>
        <button type="button" class="ax-btn treat" id="btnTreat">
          <span class="label">æ²»ç™‚ Â¥5,000</span>
        </button>
        <button type="button" class="ax-btn" id="btnBuy">
          <span class="label">ä»•å…¥ã‚Œ</span>
        </button>
        <button type="button" class="ax-btn" id="btnAddTank">
          <span class="label">æ°´æ§½+ Â¥20,000</span>
        </button>
      </div>
    </div>

    <div class="ax-log" id="axLog">ã‚·ãƒ§ãƒƒãƒ—ã‚’å§‹ã‚ãŸã€‚è¦ªã‚¦ãƒ‘2åŒ¹ãƒ»æ°´æ§½3ã¤ã‹ã‚‰ã€‚æ°´ã¨ã‚¨ã‚µã‚’æ•´ãˆã‚ˆã†ã€‚</div>

    <a href="/index.html" class="ax-back">â† ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
  </div>

  <div class="ax-overlay" id="axOverlayBreed">
    <div class="ax-overlay-box">
      <h2>äº¤é…ã™ã‚‹2åŒ¹ã‚’é¸ã¶</h2>
      <p style="font-size:12px; margin-bottom:8px;">è¦ª1ãƒ»è¦ª2ã«12ãƒ¶æœˆä»¥ä¸Šã®æˆä½“ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚é¸ã‚“ã 2åŒ¹ãŒ1ã¤ã®æ°´æ§½ã«å…¥ã‚Šã€1ã€œ3ãƒ¶æœˆå¾Œã«çµæœãŒå‡ºã¾ã™ã€‚</p>
      <div style="margin-bottom:8px;">
        <label>è¦ª1ã®æ°´æ§½</label>
        <select id="axBreedParent1" style="display:block; width:100%; padding:6px; margin-top:2px;"></select>
      </div>
      <div style="margin-bottom:12px;">
        <label>è¦ª2ã®æ°´æ§½</label>
        <select id="axBreedParent2" style="display:block; width:100%; padding:6px; margin-top:2px;"></select>
      </div>
      <button type="button" class="btn" id="axBreedConfirm">äº¤é…ã™ã‚‹</button>
      <button type="button" class="btn" style="margin-left:8px; background:#64748b; border-color:#64748b;" id="axBreedCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div class="ax-overlay" id="axOverlayTreat">
    <div class="ax-overlay-box">
      <h2>æ²»ç™‚ã™ã‚‹ã‚¦ãƒ‘ã‚’é¸ã¶</h2>
      <p style="font-size:12px; margin-bottom:8px;">ç—…æ°—ã®ã‚¦ãƒ‘ã‚’é¸ã¶ã¨Â¥5,000ã§æ²»ç™‚ã‚’é–‹å§‹ã—ã¾ã™ã€‚ç¿Œæœˆã«ä¸€å®šç¢ºç‡ã§å›å¾©ã—ã¾ã™ã€‚</p>
      <div id="axTreatTankList" style="margin-bottom:12px;"></div>
      <button type="button" class="btn" style="background:#64748b; border-color:#64748b;" id="axTreatCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div class="ax-overlay" id="axOverlayBuy">
    <div class="ax-overlay-box">
      <h2>ã‚¦ãƒ‘ã‚’ä»•å…¥ã‚Œã‚‹ï¼ˆç¨®é¡ãƒ»ã‚µã‚¤ã‚ºã‚’é¸ã¶ï¼‰</h2>
      <p style="font-size:12px; margin-bottom:8px;">ã‚¿ãƒ–ã§ç¨®é¡ã‚’é¸ã³ã€ã‚µã‚¤ã‚ºã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
      <div id="axBuyTabs" class="ax-buy-tabs" style="display:flex; gap:4px; margin-bottom:10px; flex-wrap:wrap;"></div>
      <div id="axBuyTypeList" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-bottom:12px; max-height:50vh; overflow-y:auto;"></div>
      <button type="button" class="btn" style="background:#64748b; border-color:#64748b;" id="axBuyCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div class="ax-overlay" id="axOverlayEnd">
    <div class="ax-overlay-box">
      <h2 id="axEndTitle">ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°</h2>
      <p id="axEndMessage"></p>
      <button type="button" class="btn" id="axBtnRetry">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
      <div style="margin-top:8px;">
        <a href="/index.html" style="font-size:12px; color:#0369a1; text-decoration:none;">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
      </div>
    </div>
  </div>

  <script src="/assets/header.js"></script>
  <script>
(function () {
  'use strict';

  var MAX_CLEAN = 100;
  var MAX_FOOD = 100;
  var MAX_REP = 100;
  var MAX_HEALTH = 100;
  var TARGET_MONEY = 200000;
  var MAX_TANKS = 10;
  var WATER_CHANGE_COST = 1000;

  var AXO_TYPES = ['nomal', 'albino', 'gold', 'marble', 'copper', 'black'];
  var typeLabels = {
    nomal: 'ãƒãƒ¼ãƒãƒ«(ç™½)',
    albino: 'ã‚¢ãƒ«ãƒ“ãƒ',
    gold: 'ã‚´ãƒ¼ãƒ«ãƒ‰',
    marble: 'ãƒãƒ¼ãƒ–ãƒ«',
    copper: 'éŠ…',
    black: 'ãƒ–ãƒ©ãƒƒã‚¯'
  };
  var typePriceBase = {
    nomal: 8000,
    albino: 12000,
    gold: 18000,
    marble: 22000,
    copper: 15000,
    black: 25000
  };
  var MAX_HUNGER = 100;
  var SICK_PRICE_RATE = 0.2;
  var TREATMENT_COST = 5000;
  var TREATMENT_RECOVER_CHANCE = 0.35;
  var SICK_CHANCE_PER_DAY = 0.04;
  var SICK_INJURY_CHANCE = 0.03;
  var SICK_DEATH_CHANCE = 0.02;
  var SICK_CHANCE_PER_MONTH = 0.12;
  var HUNGER_DECAY_PER_MONTH = 15;
  var FEED_ARTIFICIAL_COST = 1500;
  var FEED_BLOODWORM_COST = 500;
  var FEED_BLOODWORM_DIRT = 12;
  var FEED_BLOODWORM_HEALTH = 8;
  var FEED_BLOODWORM_HUNGER = 25;
  var FEED_EARTHWORM_COST = 2500;
  var FEED_EARTHWORM_DIRT = 6;
  var FEED_EARTHWORM_HEALTH = 12;
  var FEED_EARTHWORM_HUNGER = 30;
  var FEED_ARTIFICIAL_DIRT = 3;
  var FEED_ARTIFICIAL_HEALTH = 5;
  var FEED_ARTIFICIAL_HUNGER = 20;
  function typeImagePath(t) {
    return '/assets/axolotl/axo_' + t + '.png';
  }

  // ã‚³ãƒƒãƒ‘ãƒ¼ã¯ã‚·ãƒ§ãƒƒãƒ—ã§å£²ã£ã¦ã„ãªã„ï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰ã€‚äº¤é…ã§ã”ãä½ç¢ºç‡ã§ã®ã¿å‡ºç¾
  var AXO_TYPES_BUY = ['nomal', 'albino', 'gold', 'marble', 'black'];

  // äº¤é…ç¢ºç‡ãƒ†ãƒ¼ãƒ–ãƒ«: breedingTable[è¦ª1ã‚¿ã‚¤ãƒ—][è¦ª2ã‚¿ã‚¤ãƒ—] = { å­ã‚¿ã‚¤ãƒ—: é‡ã¿, ... }
  // copper ã¯é‡ã¿1ã§ã”ãä½ç¢ºç‡
  var breedingTable = (function () {
    var types = AXO_TYPES;
    var table = {};
    types.forEach(function (k) { table[k] = {}; });
    types.forEach(function (t1) {
      types.forEach(function (t2) {
        if (table[t1][t2]) return;
        var weights = {};
        types.forEach(function (k) {
          var w = (k === t1 || k === t2) ? 35 : 10;
          if (t1 === t2) w = k === t1 ? 60 : 8;
          if (k === 'copper') w = 1;
          weights[k] = w;
        });
        table[t1][t2] = weights;
        table[t2][t1] = weights;
      });
    });
    return table;
  })();

  function pickOffspringType(parent1Type, parent2Type) {
    var weights = breedingTable[parent1Type][parent2Type] || breedingTable[parent2Type][parent1Type];
    if (!weights) return AXO_TYPES[0];
    var total = 0;
    AXO_TYPES.forEach(function (k) { total += weights[k] || 0; });
    var r = Math.random() * total;
    for (var i = 0; i < AXO_TYPES.length; i++) {
      var k = AXO_TYPES[i];
      r -= weights[k] || 0;
      if (r <= 0) return k;
    }
    return AXO_TYPES[AXO_TYPES.length - 1];
  }

  var state = {
    month: 1,
    money: 50000,
    clean: 80,
    reputation: 30,
    tanks: [],
    ended: false,
    lastBreedParent1: null,
    lastBreedParent2: null
  };

  function $(id) { return document.getElementById(id); }

  function randInt(min, max) {
    return min + Math.floor(Math.random() * (max - min + 1));
  }

  function clamp(v, min, max) {
    return v < min ? min : (v > max ? max : v);
  }

  function formatMoney(y) {
    return 'Â¥' + y.toLocaleString('ja-JP');
  }

  var SHADE_VALUES = ['light', 'normal', 'dark'];
  var shadeLabels = { light: 'è–„ã‚', normal: 'æ™®é€š', dark: 'æ¿ƒã„ã‚' };
  var shadePriceRate = { light: 0.9, normal: 1, dark: 1.15 };

  function pickRandomShade() {
    var r = Math.random();
    if (r < 0.25) return 'light';
    if (r < 0.75) return 'normal';
    return 'dark';
  }

  function createAxolotl(isAdultOrAge, type) {
    if (type == null) {
      var roll = Math.random();
      if (roll < 0.5) type = 'nomal';
      else if (roll < 0.75) type = 'albino';
      else if (roll < 0.88) type = 'gold';
      else if (roll < 0.95) type = 'marble';
      else if (roll < 0.98) type = 'copper';
      else type = 'black';
    }
    var age = typeof isAdultOrAge === 'number' ? isAdultOrAge : (isAdultOrAge ? randInt(18, 24) : 0);
    return {
      age: age,
      health: clamp(70 + randInt(-10, 10), 40, MAX_HEALTH),
      type: type,
      sex: Math.random() < 0.5 ? 'â™‚' : 'â™€',
      shade: pickRandomShade(),
      injured: false,
      hunger: age >= 12 ? 80 : 70,
      sick: false,
      underTreatment: false
    };
  }

  function ageFromSizeBand(band) {
    var ages = [1, 2, 4, 7, 9, 12, 15, 21];
    return ages[band] != null ? ages[band] : 21;
  }

  var sizeBandLabels = ['2-3cm(å¹¼ç”Ÿ)', '3-5cm', '5-8cm', '8-12cm', '12-16cm', '16-18cm', '18-21cm(ç¹æ®–ç”¨)', 'æˆä½“'];

  function initTanks() {
    state.tanks = [];
    state.tanks.push({
      id: 1,
      axolotl: createAxolotl(true, 'nomal'),
      note: 'è¦ªã‚¦ãƒ‘',
      baby: false
    });
    state.tanks.push({
      id: 2,
      axolotl: createAxolotl(true, 'nomal'),
      note: 'è¦ªã‚¦ãƒ‘',
      baby: false
    });
    state.tanks.push({
      id: 3,
      axolotl: null,
      note: 'ç©ºãæ°´æ§½',
      baby: false
    });
  }

  function tankName(index, tank) {
    if (tank.breedingPair) return 'æ°´æ§½' + (index + 1) + 'ï¼ˆç¹æ®–ä¸­ï¼‰';
    if (tank.egg) return 'æ°´æ§½' + (index + 1) + 'ï¼ˆåµï¼‰';
    if (!tank.axolotl) return 'æ°´æ§½' + (index + 1) + 'ï¼ˆç©ºï¼‰';
    return 'æ°´æ§½' + (index + 1);
  }

  function typeLabel(t) {
    return typeLabels[t] || typeLabels.nomal;
  }

  function sizeBandFromAge(age) {
    if (age <= 2) return 0;
    if (age <= 4) return 1;
    if (age <= 6) return 2;
    if (age <= 9) return 3;
    if (age <= 12) return 4;
    if (age <= 15) return 5;
    if (age <= 18) return 6;
    return 7;
  }
  var sizePriceTable = {
    nomal: [5500, 7400, 8900, 12700, 15800, 24800, 43000, 45000],
    albino: [5500, 7400, 8900, 12700, 15800, 24800, 38000, 40000],
    gold: [5900, 9200, 9400, 12700, 15800, 24800, 43000, 45000],
    marble: [5500, 7400, 8900, 12700, 15800, 24800, 38000, 40000],
    black: [13200, 13200, 13200, 13200, 16800, 26200, 43000, 45000],
    copper: [5500, 7400, 8900, 12700, 15800, 24800, 43000, 45000]
  };
  function calcPrice(ax) {
    var band = sizeBandFromAge(ax.age);
    var bandPrices = sizePriceTable[ax.type] || sizePriceTable.nomal;
    var base = (bandPrices[band] || bandPrices[bandPrices.length - 1]) || 8000;
    var healthRate = ax.health / 100;
    var repBonus = 0.7 + state.reputation / 150;
    var shadeRate = shadePriceRate[ax.shade] != null ? shadePriceRate[ax.shade] : 1;
    var price = base * healthRate * repBonus * shadeRate;
    if (ax.sick) price *= SICK_PRICE_RATE;
    if (ax.injured) price *= 0.3;
    return Math.round(price / 1000) * 1000;
  }

  function updateTanksDOM() {
    var root = $('axTanks');
    root.innerHTML = '';
    state.tanks.forEach(function (tank, idx) {
      var div = document.createElement('div');
      div.className = 'ax-tank';

      var header = document.createElement('div');
      header.className = 'ax-tank-header';
      var nameEl = document.createElement('div');
      nameEl.className = 'ax-tank-name';
      nameEl.textContent = tankName(idx, tank);
      var tag = document.createElement('div');
      tag.className = 'ax-tank-tag';
      if (tank.breedingPair) tag.textContent = 'ç¹æ®–ä¸­';
      else if (tank.egg) tag.textContent = 'åµ';
      else tag.textContent = tank.axolotl ? (tank.baby ? 'å­ã‚¦ãƒ‘' : 'æˆä½“') : 'ç©ºã';
      header.appendChild(nameEl);
      header.appendChild(tag);
      div.appendChild(header);

      var body = document.createElement('div');
      body.className = 'ax-tank-body';
      var lines = document.createElement('div');
      lines.className = 'ax-tank-lines';
      if (tank.breedingPair) {
        var months = tank.breedingMonthsLeft != null ? tank.breedingMonthsLeft : 0;
        lines.textContent = 'è¦ª1ï¼š' + typeLabel(tank.breedingPair[0].type) + ' ' + tank.breedingPair[0].sex + '\nè¦ª2ï¼š' + typeLabel(tank.breedingPair[1].type) + ' ' + tank.breedingPair[1].sex + '\nã‚ã¨' + months + 'ãƒ¶æœˆã§çµæœ';
      } else if (tank.egg) {
        lines.textContent = 'åµãŒå­µåŒ–ã™ã‚‹ã¾ã§ã‚ã¨' + (tank.hatchMonthsLeft != null ? tank.hatchMonthsLeft : 1) + 'ãƒ¶æœˆ';
      } else if (tank.axolotl) {
        var ax = tank.axolotl;
        lines.textContent =
          'æ€§åˆ¥ï¼š' + ax.sex + '\n' +
          'ç¨®é¡ï¼š' + typeLabel(ax.type) + '\n' +
          'è‰²å‘³ï¼š' + (shadeLabels[ax.shade] || 'æ™®é€š') + '\n' +
          'å¹´é½¢ï¼š' + ax.age + 'ãƒ¶æœˆ\n' +
          'å¥åº·ï¼š' + Math.round(ax.health) + '/100' + (ax.injured ? '\næ¬ æ' : '') + (ax.sick ? '\nç—…æ°—' : '') + (ax.underTreatment ? '\næ²»ç™‚ä¸­' : '');
      } else {
        lines.textContent = tank.note;
      }
      body.appendChild(lines);

      if (tank.breedingPair) {
        var pair = tank.breedingPair;
        var wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.gap = '4px';
        [pair[0], pair[1]].forEach(function (ax) {
          var sprite = document.createElement('img');
          sprite.className = 'ax-axolotl-img ax-shade-' + (ax.shade || 'normal') + (ax.injured || ax.sick ? '' : ' alive');
          sprite.src = typeImagePath(ax.type);
          sprite.alt = typeLabel(ax.type);
          wrap.appendChild(sprite);
        });
        body.appendChild(wrap);
      } else if (tank.egg) {
        var eggEl = document.createElement('div');
        eggEl.className = 'ax-tank-egg';
        eggEl.textContent = 'ğŸ¥š';
        body.appendChild(eggEl);
      } else if (tank.axolotl) {
        var ax = tank.axolotl;
        var sprite = document.createElement('img');
        sprite.className = 'ax-axolotl-img ax-shade-' + (ax.shade || 'normal') + (ax.injured || ax.sick ? '' : ' alive');
        sprite.src = typeImagePath(ax.type);
        sprite.alt = typeLabel(ax.type);
        body.appendChild(sprite);
      }
      div.appendChild(body);

      var foot = document.createElement('div');
      foot.className = 'ax-tank-footer';
      if (tank.axolotl) {
        var price = calcPrice(tank.axolotl);
        foot.innerHTML = '';
        var priceSpan = document.createElement('span');
        priceSpan.textContent = 'äºˆæƒ³è²©å£²ï¼š' + formatMoney(price);
        foot.appendChild(priceSpan);
        var sellBtn = document.createElement('button');
        sellBtn.type = 'button';
        sellBtn.className = 'ax-tank-sell';
        sellBtn.textContent = 'å£²ã‚‹';
        sellBtn.dataset.tankIndex = String(idx);
        sellBtn.addEventListener('click', function () {
          actSellTank(parseInt(this.dataset.tankIndex, 10));
        });
        foot.appendChild(sellBtn);
      } else if (tank.breedingPair || tank.egg) {
        foot.textContent = tank.note || (tank.egg ? 'å­µåŒ–ã‚’å¾…ã¤' : 'ç¹æ®–çµæœã‚’å¾…ã¤');
      } else {
        foot.textContent = tank.note || 'ã“ã“ã«æ–°ã—ã„ã‚¦ãƒ‘ã‚’å…¥ã‚Œã‚‰ã‚Œã‚‹ã€‚';
      }
      div.appendChild(foot);

      root.appendChild(div);
    });
  }

  function updateUI() {
    $('axDay').textContent = state.month + 'æœˆç›®';
    $('axMoney').textContent = formatMoney(state.money);
    $('axCleanBar').style.width = clamp(state.clean, 0, MAX_CLEAN) / MAX_CLEAN * 100 + '%';
    $('axRepBar').style.width = clamp(state.reputation, 0, MAX_REP) / MAX_REP * 100 + '%';

    var disabled = state.ended;
    $('btnNextMonth').disabled = disabled;
    $('btnFeedArtificial').disabled = disabled;
    $('btnFeedBloodworm').disabled = disabled;
    $('btnFeedEarthworm').disabled = disabled;
    $('btnClean').disabled = disabled;
    $('btnBreed').disabled = disabled;
    $('btnTreat').disabled = disabled;
    $('btnBuy').disabled = disabled;
    $('btnAddTank').disabled = disabled;

    updateTanksDOM();
  }

  function logLine(text) {
    var log = $('axLog');
    var prefix = 'ã€' + state.month + 'æœˆç›®ã€‘';
    var line = prefix + ' ' + text;
    log.textContent = line + (log.textContent ? '\n' + log.textContent : '');
  }

  function checkEnd() {
    if (state.ended) return;
    if (state.money >= TARGET_MONEY && state.reputation >= 60) {
      state.ended = true;
      $('axOverlayEnd').classList.add('visible');
      $('axEndTitle').textContent = 'äººæ°—åº—ã‚¨ãƒ³ãƒ‰';
      $('axEndMessage').textContent =
        'æ‰€æŒé‡‘ ' + formatMoney(state.money) + 'ã€è©•åˆ¤ ' + Math.round(state.reputation) + 'ã€‚\n' +
        'å¤§åˆ‡ã«è‚²ã¦ãŸã‚¦ãƒ¼ãƒ‘ãƒ¼ãƒ«ãƒ¼ãƒ‘ãƒ¼ã®ãŠã‹ã’ã§ã€åœ°åŸŸã§æœ‰åãªã‚·ãƒ§ãƒƒãƒ—ã«ãªã£ãŸã€‚';
      updateUI();
      return;
    }
    var hasAxolotlOrHope = state.tanks.some(function (t) { return t.axolotl || t.breedingPair || t.egg; });
    if (state.money <= 0 && !hasAxolotlOrHope) {
      state.ended = true;
      $('axOverlayEnd').classList.add('visible');
      $('axEndTitle').textContent = 'é–‰åº—ã‚¨ãƒ³ãƒ‰';
      $('axEndMessage').textContent =
        'è³‡é‡‘ã‚‚ã‚¦ãƒ¼ãƒ‘ãƒ¼ãƒ«ãƒ¼ãƒ‘ãƒ¼ã‚‚å°½ãã¦ã—ã¾ã£ãŸã€‚\n' +
        'æ¬¡ã¯ã€æ°´ã¨ã‚¨ã‚µã‚’å„ªå…ˆã—ã¦ã€ã‚†ã£ãã‚Šå¢—ã‚„ã—ã¦ã„ã“ã†ã€‚';
      updateUI();
    }
  }

  function resolveBreeding(tankIdx) {
    var tank = state.tanks[tankIdx];
    if (!tank || !tank.breedingPair) return;
    var pair = tank.breedingPair;
    var emptySlots = [];
    state.tanks.forEach(function (t, i) {
      if (!t.axolotl && !t.breedingPair && !t.egg) emptySlots.push(i);
    });
    var success = Math.random() < 0.7;
    if (success && emptySlots.length >= 2) {
      state.tanks[emptySlots[0]].axolotl = pair[0];
      state.tanks[emptySlots[0]].note = 'è¦ªã‚¦ãƒ‘';
      state.tanks[emptySlots[1]].axolotl = pair[1];
      state.tanks[emptySlots[1]].note = 'è¦ªã‚¦ãƒ‘';
      tank.breedingPair = null;
      tank.breedingMonthsLeft = null;
      tank.egg = true;
      tank.eggParentTypes = [pair[0].type, pair[1].type];
      tank.hatchMonthsLeft = 1;
      tank.note = 'åµï¼ˆã‚ã¨1ãƒ¶æœˆã§å­µåŒ–ï¼‰';
      state.reputation = clamp(state.reputation + 3, 0, MAX_REP);
      logLine('ç¹æ®–ã«æˆåŠŸï¼æ°´æ§½' + (tankIdx + 1) + 'ã«åµãŒç”£ã¾ã‚ŒãŸã€‚');
    } else if (success) {
      emptySlots.push(tankIdx);
      for (var i = 0; i < pair.length && i < emptySlots.length; i++) {
        state.tanks[emptySlots[i]].axolotl = pair[i];
        state.tanks[emptySlots[i]].note = 'è¦ªã‚¦ãƒ‘';
      }
      tank.breedingPair = null;
      tank.breedingMonthsLeft = null;
      tank.note = 'ç©ºãæ°´æ§½';
      logLine('ç¹æ®–ã¯æˆåŠŸã—ãŸãŒã€ç©ºãæ°´æ§½ãŒè¶³ã‚Šãšåµã‚’ç½®ã‘ãªã‹ã£ãŸã€‚');
    } else {
      var bigFail = Math.random() < 0.15;
      var survivors = [];
      if (bigFail) {
        [0, 1].forEach(function (i) {
          var ax = pair[i];
          var roll = Math.random();
          if (roll < 0.1) {
            logLine(typeLabel(ax.type) + 'ãŒç¹æ®–ä¸­ã®äº‹æ•…ã§â˜…ã«ãªã£ã¦ã—ã¾ã£ãŸâ€¦');
            state.reputation = clamp(state.reputation - 8, 0, MAX_REP);
          } else if (roll < 0.4) {
            ax.injured = true;
            survivors.push(ax);
            logLine(typeLabel(ax.type) + 'ãŒæ¬ æã‚’è² ã£ãŸã€‚å€¤æ®µãŒä¸‹ãŒã‚‹ã€‚');
          } else {
            survivors.push(ax);
          }
        });
      } else {
        survivors = [pair[0], pair[1]];
        logLine('ç¹æ®–ã«å¤±æ•—ã—ãŸã€‚');
      }
      tank.breedingPair = null;
      tank.breedingMonthsLeft = null;
      tank.note = 'ç©ºãæ°´æ§½';
      var slotsForSurvivors = emptySlots.slice();
      if (slotsForSurvivors.indexOf(tankIdx) < 0) slotsForSurvivors.push(tankIdx);
      for (var j = 0; j < survivors.length && j < slotsForSurvivors.length; j++) {
        state.tanks[slotsForSurvivors[j]].axolotl = survivors[j];
        state.tanks[slotsForSurvivors[j]].note = survivors[j].injured ? 'æ¬ æã‚ã‚Š' : 'è¦ªã‚¦ãƒ‘';
      }
    }
  }

  function countOccupiedTanks() {
    return state.tanks.filter(function (t) { return t.axolotl || t.breedingPair; }).length;
  }

  function endOfMonthDrift() {
    state.clean = clamp(state.clean - (5 + state.tanks.length), 0, MAX_CLEAN);
    state.tanks.forEach(function (tank, idx) {
      if (tank.breedingPair) {
        tank.breedingPair.forEach(function (a) {
          a.hunger = clamp((a.hunger || MAX_HUNGER) - HUNGER_DECAY_PER_MONTH, 0, MAX_HUNGER);
        });
        tank.breedingMonthsLeft = (tank.breedingMonthsLeft || 0) - 1;
        if (tank.breedingMonthsLeft <= 0) resolveBreeding(idx);
        return;
      }
      if (tank.egg) {
        tank.hatchMonthsLeft = (tank.hatchMonthsLeft || 1) - 1;
        if (tank.hatchMonthsLeft <= 0) {
          var parentTypes = tank.eggParentTypes || ['nomal', 'nomal'];
          var offspringType = Math.random() < 0.85
            ? parentTypes[Math.floor(Math.random() * parentTypes.length)]
            : pickOffspringType(parentTypes[0], parentTypes[1]);
          var baby = createAxolotl(false, offspringType);
          tank.egg = false;
          tank.eggParentTypes = null;
          tank.hatchMonthsLeft = null;
          tank.axolotl = baby;
          tank.baby = true;
          tank.note = 'ç¹æ®–ã§ç”Ÿã¾ã‚ŒãŸå­ã‚¦ãƒ‘';
          logLine('åµãŒå­µåŒ–ï¼' + typeLabel(offspringType) + 'ã®å­ã‚¦ãƒ¼ãƒ‘ãƒ¼ãƒ«ãƒ¼ãƒ‘ãƒ¼ãŒç”Ÿã¾ã‚ŒãŸã€‚');
        }
        return;
      }
      if (!tank.axolotl) return;
      var ax = tank.axolotl;
      ax.hunger = clamp((ax.hunger || MAX_HUNGER) - HUNGER_DECAY_PER_MONTH, 0, MAX_HUNGER);
      if (state.clean < 40) ax.health -= 12;
      else if (state.clean < 70) ax.health -= 6;
      if (ax.hunger < 30) ax.health -= 6;
      ax.health = clamp(ax.health, 0, MAX_HEALTH);
      if (!ax.sick && (state.clean < 40 || ax.hunger < 30) && Math.random() < SICK_CHANCE_PER_MONTH) {
        ax.sick = true;
        logLine(typeLabel(ax.type) + 'ã®ã‚¦ãƒ‘ãŒç—…æ°—ã«ãªã£ãŸã€‚');
      }
      if (ax.sick) {
        if (ax.underTreatment && Math.random() < TREATMENT_RECOVER_CHANCE) {
          ax.sick = false;
          ax.underTreatment = false;
          logLine(typeLabel(ax.type) + 'ã®ã‚¦ãƒ‘ãŒæ²»ç™‚ã§å›å¾©ã—ãŸã€‚');
        } else if (!ax.underTreatment) {
          if (Math.random() < SICK_DEATH_CHANCE) {
            tank.axolotl = null;
            tank.note = 'ç—…æ°—ã§â˜…ã«ãªã£ã¦ã—ã¾ã£ãŸâ€¦';
            logLine('ã‚¦ãƒ¼ãƒ‘ãƒ¼ãƒ«ãƒ¼ãƒ‘ãƒ¼ãŒ1åŒ¹ç—…æ°—ã§â˜…ã«ãªã£ã¦ã—ã¾ã£ãŸã€‚');
            state.reputation = clamp(state.reputation - 10, 0, MAX_REP);
            return;
          }
          if (Math.random() < SICK_INJURY_CHANCE) {
            ax.injured = true;
            logLine(typeLabel(ax.type) + 'ã®ã‚¦ãƒ‘ãŒç—…æ°—ã§æ¬ æã‚’è² ã£ãŸã€‚');
          }
        }
      }
      ax.age += 1;
      if (ax.age >= 4 && tank.baby) {
        tank.baby = false;
        tank.note = 'è‚²ã£ãŸã‚¦ãƒ‘';
      }
      if (ax.health <= 0) {
        tank.axolotl = null;
        tank.note = 'ä½“èª¿ã‚’å´©ã—ã¦â˜…ã«ãªã£ã¦ã—ã¾ã£ãŸâ€¦';
        logLine('æ°´ã‚„ã‚¨ã‚µã®çŠ¶æ…‹ãŒæ‚ªãã€ã‚¦ãƒ¼ãƒ‘ãƒ¼ãƒ«ãƒ¼ãƒ‘ãƒ¼ãŒ1åŒ¹â˜…ã«ãªã£ã¦ã—ã¾ã£ãŸã€‚');
        state.reputation = clamp(state.reputation - 10, 0, MAX_REP);
      }
    });
    if (state.clean < 40) {
      state.reputation = clamp(state.reputation - 4, 0, MAX_REP);
    }
  }

  function nextMonth() {
    state.month += 1;
    endOfMonthDrift();
    checkEnd();
    updateUI();
  }

  function applyFeedToTanks(healthBonus, hungerBonus, cleanPenalty) {
    state.clean = clamp(state.clean - cleanPenalty, 0, MAX_CLEAN);
    state.tanks.forEach(function (tank) {
      if (tank.axolotl) {
        tank.axolotl.health = clamp(tank.axolotl.health + healthBonus, 0, MAX_HEALTH);
        tank.axolotl.hunger = clamp((tank.axolotl.hunger || 80) + hungerBonus, 0, MAX_HUNGER);
      }
      if (tank.breedingPair) {
        tank.breedingPair.forEach(function (ax) {
          ax.health = clamp(ax.health + healthBonus, 0, MAX_HEALTH);
          ax.hunger = clamp((ax.hunger || 80) + hungerBonus, 0, MAX_HUNGER);
        });
      }
    });
  }

  function actFeedArtificial() {
    var occupied = countOccupiedTanks();
    if (occupied === 0) {
      logLine('ã‚¨ã‚µã‚’ã‚ã’ã‚‹å¯¾è±¡ã®æ°´æ§½ãŒãªã„ã€‚');
      return;
    }
    if (state.money < FEED_ARTIFICIAL_COST) {
      logLine('äººå·¥é£¼æ–™ä»£ãŒè¶³ã‚Šãªã„â€¦ã€‚ï¼ˆÂ¥1,500ï¼‰');
      return;
    }
    state.money -= FEED_ARTIFICIAL_COST;
    applyFeedToTanks(FEED_ARTIFICIAL_HEALTH, FEED_ARTIFICIAL_HUNGER, FEED_ARTIFICIAL_DIRT * occupied);
    logLine('äººå·¥é£¼æ–™ã‚’ã‚ã’ãŸã€‚æ±šã‚Œä½ãƒ»æˆé•·æ™®é€šã€‚');
    updateUI();
  }

  function actFeedBloodworm() {
    if (state.money < FEED_BLOODWORM_COST) {
      logLine('ã‚¢ã‚«ãƒ ã‚·ä»£ãŒè¶³ã‚Šãªã„â€¦ã€‚');
      return;
    }
    state.money -= FEED_BLOODWORM_COST;
    applyFeedToTanks(FEED_BLOODWORM_HEALTH, FEED_BLOODWORM_HUNGER, FEED_BLOODWORM_DIRT);
    logLine('ã‚¢ã‚«ãƒ ã‚·ã‚’ã‚ã’ãŸã€‚æ±šã‚Œé«˜ãƒ»æˆé•·ã‚„ã‚„é«˜ï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆï¼‰ã€‚');
    updateUI();
  }

  function actFeedEarthworm() {
    if (state.money < FEED_EARTHWORM_COST) {
      logLine('ãƒŸãƒŸã‚ºä»£ãŒè¶³ã‚Šãªã„â€¦ã€‚');
      return;
    }
    state.money -= FEED_EARTHWORM_COST;
    applyFeedToTanks(FEED_EARTHWORM_HEALTH, FEED_EARTHWORM_HUNGER, FEED_EARTHWORM_DIRT);
    logLine('ãƒŸãƒŸã‚ºã‚’ã‚ã’ãŸã€‚æ±šã‚Œä¸­ãƒ»æˆé•·æœ€é«˜ï¼ˆè‚²æˆç‰¹åŒ–ï¼‰ã€‚');
    updateUI();
  }

  function actClean() {
    if (state.money < WATER_CHANGE_COST) {
      logLine('æ°´æ›ãˆã®è²»ç”¨ãŒè¶³ã‚Šãªã„â€¦ã€‚');
      return;
    }
    state.money -= WATER_CHANGE_COST;
    state.clean = clamp(state.clean + 25, 0, MAX_CLEAN);
    logLine('æ°´ã‚’ã‹ãˆãŸã€‚æ°´è³ªãŒä¸ŠãŒã£ãŸã€‚');
    updateUI();
  }

  function actSellTank(idx) {
    var tank = state.tanks[idx];
    if (!tank || !tank.axolotl) return;
    var price = calcPrice(tank.axolotl);
    state.money += price;
    var typeName = typeLabel(tank.axolotl.type);
    tank.axolotl = null;
    tank.note = 'ç©ºãæ°´æ§½';
    tank.baby = false;
    state.reputation = clamp(state.reputation + 2, 0, MAX_REP);
    logLine(typeName + 'ã®ã‚¦ãƒ‘ã‚’' + formatMoney(price) + 'ã§è²©å£²ã—ãŸã€‚');
    updateUI();
  }

  function getAdultTanks() {
    return state.tanks.map(function (t, idx) {
      return { tank: t, idx: idx };
    }).filter(function (x) {
      return x.tank.axolotl && !x.tank.breedingPair && x.tank.axolotl.age >= 12 && x.tank.axolotl.health >= 50 && !x.tank.axolotl.injured && !x.tank.axolotl.sick;
    });
  }

  function fillBreedParent2Excluding(sel1, sel2, adults) {
    var aIdx = parseInt(sel1.value, 10);
    var parent1 = state.tanks[aIdx] && state.tanks[aIdx].axolotl;
    var parent1Sex = parent1 ? parent1.sex : null;
    sel2.innerHTML = '';
    adults.forEach(function (x) {
      if (x.idx === aIdx) return;
      if (parent1Sex && x.tank.axolotl.sex === parent1Sex) return;
      var opt = document.createElement('option');
      opt.value = String(x.idx);
      opt.textContent = 'æ°´æ§½' + (x.idx + 1) + 'ï¼ˆ' + typeLabel(x.tank.axolotl.type) + ' ' + x.tank.axolotl.sex + 'ï¼‰';
      sel2.appendChild(opt);
    });
    var curB = parseInt(sel2.value, 10);
    if (curB === aIdx || [].slice.call(sel2.options).every(function (o) { return parseInt(o.value, 10) !== curB; })) {
      if (sel2.options.length) sel2.value = sel2.options[0].value;
    }
  }

  function openBreedOverlay() {
    var adults = getAdultTanks();
    var empty = state.tanks.find(function (t) { return !t.axolotl && !t.breedingPair && !t.egg; });
    if (adults.length < 2 || !empty) {
      logLine('12ãƒ¶æœˆä»¥ä¸Šã®æˆä½“2åŒ¹ã¨ç©ºãæ°´æ§½ãŒå¿…è¦ã ã€‚');
      return;
    }
    var hasMaleAndFemale = adults.some(function (a) {
      return adults.some(function (b) {
        return a.idx !== b.idx && a.tank.axolotl.sex !== b.tank.axolotl.sex;
      });
    });
    if (!hasMaleAndFemale) {
      logLine('äº¤é…ã«ã¯ã‚ªã‚¹ã¨ãƒ¡ã‚¹ãŒ1åŒ¹ãšã¤å¿…è¦ã ã€‚');
      return;
    }
    var sel1 = $('axBreedParent1');
    var sel2 = $('axBreedParent2');
    sel1.innerHTML = '';
    adults.forEach(function (x) {
      var opt = document.createElement('option');
      opt.value = String(x.idx);
      opt.textContent = 'æ°´æ§½' + (x.idx + 1) + 'ï¼ˆ' + typeLabel(x.tank.axolotl.type) + ' ' + x.tank.axolotl.sex + 'ï¼‰';
      sel1.appendChild(opt);
    });
    var last1 = state.lastBreedParent1;
    var last2 = state.lastBreedParent2;
    var validLast1 = adults.some(function (x) { return x.idx === last1; });
    var validLast2 = adults.some(function (x) { return x.idx === last2; }) && last1 !== last2;
    if (validLast1) {
      sel1.value = String(last1);
      fillBreedParent2Excluding(sel1, sel2, adults);
      if (validLast2 && last2 !== last1 && [].slice.call(sel2.options).some(function (o) { return o.value === String(last2); })) {
        sel2.value = String(last2);
      } else if (sel2.options.length) sel2.value = sel2.options[0].value;
    } else {
      var found = false;
      for (var i = 0; i < adults.length; i++) {
        sel1.value = String(adults[i].idx);
        fillBreedParent2Excluding(sel1, sel2, adults);
        if (sel2.options.length > 0) {
          sel2.value = sel2.options[0].value;
          found = true;
          break;
        }
      }
      if (!found && sel2.options.length) sel2.value = sel2.options[0].value;
    }
    $('axOverlayBreed').classList.add('visible');
  }

  function doBreed(parent1Idx, parent2Idx) {
    if (parent1Idx === parent2Idx) {
      logLine('åˆ¥ã€…ã®2åŒ¹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
      return;
    }
    var t1 = state.tanks[parent1Idx];
    var t2 = state.tanks[parent2Idx];
    var emptyIdx = state.tanks.findIndex(function (t) { return !t.axolotl && !t.breedingPair && !t.egg; });
    if (!t1 || !t2 || !t1.axolotl || !t2.axolotl || emptyIdx < 0) {
      logLine('æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚');
      return;
    }
    if (t1.axolotl.sex === t2.axolotl.sex) {
      logLine('ã‚ªã‚¹ã¨ãƒ¡ã‚¹ã‚’1åŒ¹ãšã¤é¸ã‚“ã§ãã ã•ã„ã€‚åŒã˜æ€§åˆ¥ã§ã¯äº¤é…ã§ãã¾ã›ã‚“ã€‚');
      return;
    }
    if (t1.axolotl.age < 12 || t1.axolotl.health < 50 || t2.axolotl.age < 12 || t2.axolotl.health < 50) {
      logLine('12ãƒ¶æœˆä»¥ä¸Šã®æˆä½“ã§å¥åº·ãª2åŒ¹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
      return;
    }
    state.lastBreedParent1 = parent1Idx;
    state.lastBreedParent2 = parent2Idx;
    var ax1 = t1.axolotl;
    var ax2 = t2.axolotl;
    t1.axolotl = null;
    t1.note = 'ç©ºãæ°´æ§½';
    t2.axolotl = null;
    t2.note = 'ç©ºãæ°´æ§½';
    var breedingTank = state.tanks[emptyIdx];
    var daysLeft = randInt(30, 90);
    breedingTank.breedingPair = [ax1, ax2];
    breedingTank.breedingMonthsLeft = randInt(1, 3);
    breedingTank.note = 'ç¹æ®–ä¸­ï¼ˆã‚ã¨' + breedingTank.breedingMonthsLeft + 'ãƒ¶æœˆï¼‰';
    logLine('æ°´æ§½' + (emptyIdx + 1) + 'ã«' + typeLabel(ax1.type) + 'ã¨' + typeLabel(ax2.type) + 'ã‚’å…¥ã‚Œã¦ç¹æ®–ã‚’é–‹å§‹ã—ãŸã€‚');
    $('axOverlayBreed').classList.remove('visible');
    updateUI();
  }

  function openTreatmentOverlay() {
    var sickTanks = state.tanks.map(function (t, idx) {
      return { tank: t, idx: idx };
    }).filter(function (x) {
      return x.tank.axolotl && x.tank.axolotl.sick && !x.tank.axolotl.underTreatment;
    });
    if (sickTanks.length === 0) {
      logLine('æ²»ç™‚ãŒå¿…è¦ãªã‚¦ãƒ‘ãŒã„ãªã„ã€‚');
      return;
    }
    if (state.money < TREATMENT_COST) {
      logLine('æ²»ç™‚è²»ãŒè¶³ã‚Šãªã„â€¦ã€‚');
      return;
    }
    var list = $('axTreatTankList');
    list.innerHTML = '';
    sickTanks.forEach(function (x) {
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'ax-btn treat';
      btn.style.marginBottom = '6px';
      btn.textContent = 'æ°´æ§½' + (x.idx + 1) + 'ï¼š' + typeLabel(x.tank.axolotl.type) + 'ï¼ˆÂ¥5,000ï¼‰';
      btn.dataset.tankIndex = String(x.idx);
      btn.addEventListener('click', function () {
        doTreatment(parseInt(this.dataset.tankIndex, 10));
      });
      list.appendChild(btn);
    });
    $('axOverlayTreat').classList.add('visible');
  }

  function doTreatment(tankIdx) {
    var tank = state.tanks[tankIdx];
    if (!tank || !tank.axolotl || !tank.axolotl.sick || tank.axolotl.underTreatment || state.money < TREATMENT_COST) {
      $('axOverlayTreat').classList.remove('visible');
      updateUI();
      return;
    }
    state.money -= TREATMENT_COST;
    tank.axolotl.underTreatment = true;
    logLine('æ°´æ§½' + (tankIdx + 1) + 'ã®' + typeLabel(tank.axolotl.type) + 'ã®æ²»ç™‚ã‚’é–‹å§‹ã—ãŸã€‚');
    $('axOverlayTreat').classList.remove('visible');
    updateUI();
  }

  function fillBuySizeList(selectedType) {
    var list = $('axBuyTypeList');
    list.innerHTML = '';
    var bandPrices = sizePriceTable[selectedType] || sizePriceTable.nomal;
    for (var band = 0; band < sizeBandLabels.length; band++) {
      var price = bandPrices[band];
      if (!price) continue;
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'ax-buy-type-btn';
      btn.innerHTML = '<img src="' + typeImagePath(selectedType) + '" alt="" class="ax-buy-type-img">' +
        '<span class="ax-buy-type-name">' + sizeBandLabels[band] + '</span>' +
        '<span class="ax-buy-type-price">' + formatMoney(price) + '</span>';
      btn.dataset.type = selectedType;
      btn.dataset.band = String(band);
      btn.dataset.price = String(price);
      if (state.money < price) btn.disabled = true;
      btn.addEventListener('click', function () {
        doBuy(this.dataset.type, parseInt(this.dataset.band, 10), parseInt(this.dataset.price, 10));
      });
      list.appendChild(btn);
    }
  }

  function openBuyOverlay() {
    var empty = state.tanks.find(function (t) { return !t.axolotl && !t.breedingPair && !t.egg; });
    if (!empty) {
      logLine('ç©ºãæ°´æ§½ãŒãªã„ã®ã§ã€æ–°ã—ã„ã‚¦ãƒ‘ã‚’ãŠè¿ãˆã§ããªã„ã€‚');
      return;
    }
    var tabsEl = $('axBuyTabs');
    tabsEl.innerHTML = '';
    AXO_TYPES_BUY.forEach(function (type, i) {
      var tab = document.createElement('button');
      tab.type = 'button';
      tab.className = 'ax-buy-tab';
      tab.textContent = typeLabel(type);
      tab.dataset.type = type;
      if (i === 0) tab.classList.add('active');
      tab.addEventListener('click', function () {
        tabsEl.querySelectorAll('.ax-buy-tab').forEach(function (t) { t.classList.remove('active'); });
        tab.classList.add('active');
        fillBuySizeList(tab.dataset.type);
      });
      tabsEl.appendChild(tab);
    });
    fillBuySizeList(AXO_TYPES_BUY[0]);
    $('axOverlayBuy').classList.add('visible');
  }

  function doBuy(type, sizeBand, price) {
    var empty = state.tanks.find(function (t) { return !t.axolotl && !t.breedingPair && !t.egg; });
    if (!empty || state.money < price) {
      logLine('è³¼å…¥ã§ãã¾ã›ã‚“ã€‚');
      $('axOverlayBuy').classList.remove('visible');
      updateUI();
      return;
    }
    state.money -= price;
    var age = ageFromSizeBand(sizeBand);
    var ax = createAxolotl(age, type);
    empty.axolotl = ax;
    empty.baby = age < 4;
    empty.note = 'ä»•å…¥ã‚ŒãŸã‚¦ãƒ‘';
    logLine(typeLabel(type) + ' ' + sizeBandLabels[sizeBand] + 'ã‚’1åŒ¹ãŠè¿ãˆã—ãŸã€‚');
    $('axOverlayBuy').classList.remove('visible');
    updateUI();
  }

  function actAddTank() {
    if (state.tanks.length >= MAX_TANKS) {
      logLine('ã“ã‚Œä»¥ä¸Šæ°´æ§½ã¯å¢—ã‚„ã›ãªã„ã€‚');
      return;
    }
    if (state.money < 20000) {
      logLine('æ°´æ§½ã‚’å¢—ã‚„ã™è³‡é‡‘ãŒè¶³ã‚Šãªã„â€¦ã€‚');
      return;
    }
    state.money -= 20000;
    state.tanks.push({
      id: state.tanks.length + 1,
      axolotl: null,
      note: 'æ–°ã—ãå°å…¥ã—ãŸæ°´æ§½',
      baby: false
    });
    logLine('æ–°ã—ã„æ°´æ§½ã‚’1ã¤å¢—è¨­ã—ãŸã€‚');
    updateUI();
  }

  function resetGame() {
    state.month = 1;
    state.money = 50000;
    state.clean = 80;
    state.reputation = 30;
    state.ended = false;
    state.lastBreedParent1 = null;
    state.lastBreedParent2 = null;
    initTanks();
    $('axLog').textContent = 'ã‚·ãƒ§ãƒƒãƒ—ã‚’å§‹ã‚ãŸã€‚è¦ªã‚¦ãƒ‘2åŒ¹ãƒ»æ°´æ§½3ã¤ã‹ã‚‰ã€‚æ°´ã¨ã‚¨ã‚µã‚’æ•´ãˆã‚ˆã†ã€‚';
    $('axOverlayEnd').classList.remove('visible');
    $('axOverlayBreed').classList.remove('visible');
    $('axOverlayBuy').classList.remove('visible');
    $('axOverlayTreat').classList.remove('visible');
    updateUI();
  }

  $('btnNextMonth').addEventListener('click', function () {
    if (!state.ended) nextMonth();
  });
  $('btnFeedArtificial').addEventListener('click', function () {
    if (!state.ended) actFeedArtificial();
  });
  $('btnFeedBloodworm').addEventListener('click', function () {
    if (!state.ended) actFeedBloodworm();
  });
  $('btnFeedEarthworm').addEventListener('click', function () {
    if (!state.ended) actFeedEarthworm();
  });
  $('btnClean').addEventListener('click', function () {
    if (!state.ended) actClean();
  });
  $('btnBreed').addEventListener('click', function () {
    if (!state.ended) openBreedOverlay();
  });
  $('axBreedParent1').addEventListener('change', function () {
    fillBreedParent2Excluding($('axBreedParent1'), $('axBreedParent2'), getAdultTanks());
  });
  $('axBreedConfirm').addEventListener('click', function () {
    doBreed(parseInt($('axBreedParent1').value, 10), parseInt($('axBreedParent2').value, 10));
  });
  $('axBreedCancel').addEventListener('click', function () {
    $('axOverlayBreed').classList.remove('visible');
  });
  $('btnTreat').addEventListener('click', function () {
    if (!state.ended) openTreatmentOverlay();
  });
  $('axTreatCancel').addEventListener('click', function () {
    $('axOverlayTreat').classList.remove('visible');
  });
  $('btnBuy').addEventListener('click', function () {
    if (!state.ended) openBuyOverlay();
  });
  $('axBuyCancel').addEventListener('click', function () {
    $('axOverlayBuy').classList.remove('visible');
  });
  $('btnAddTank').addEventListener('click', function () {
    if (!state.ended) actAddTank();
  });
  $('axBtnRetry').addEventListener('click', function () {
    resetGame();
  });

  resetGame();
})();
  </script>
</body>
</html>

