<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>ç«¶é¦¬ã‚²ãƒ¼ãƒ  â€“ Nihatori Games</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body.game-page {
      padding-top: 48px;
      background: linear-gradient(180deg, #1a472a 0%, #2d5a3d 50%, #1a472a 100%);
      font-family: "MS PGothic", "Yu Gothic", sans-serif;
      color: #e8e8e8;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .hr-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 480px;
      padding: 12px;
      min-height: 0;
    }
    .hr-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 8px; color: #90ee90; }
    .hr-hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .hr-hud .money { color: #ffd700; font-weight: bold; }
    .hr-phase { font-size: 12px; color: #98fb98; }
    .hr-main {
      flex: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
      overflow-y: auto;
    }
    .hr-stable {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 12px;
      border: 2px solid #2d5a3d;
    }
    .hr-stable-title { font-size: 12px; color: #90ee90; margin-bottom: 8px; }
    .hr-horse-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .hr-horse-row:last-child { border-bottom: none; }
    .hr-horse-num { width: 24px; font-weight: bold; color: #ffd700; }
    .hr-horse-name { flex: 1; font-size: 14px; }
    .hr-horse-power { font-size: 11px; color: #aaa; }
    .hr-tap-btn {
      padding: 6px 12px;
      background: linear-gradient(180deg, #4a7c4e 0%, #2d5a3d 100%);
      border: 2px solid #6b8e6b;
      border-radius: 8px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .hr-tap-btn:active { transform: scale(0.95); }
    .hr-bet-section {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 12px;
      border: 2px solid #2d5a3d;
    }
    .hr-bet-title { font-size: 12px; color: #90ee90; margin-bottom: 8px; }
    .hr-bet-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .hr-bet-row label { font-size: 13px; min-width: 80px; }
    .hr-bet-row select {
      padding: 4px 8px;
      border-radius: 6px;
      background: #1a472a;
      color: #fff;
      border: 1px solid #4a7c4e;
    }
    .hr-bet-row input[type="number"] {
      width: 70px;
      padding: 4px 8px;
      border-radius: 6px;
      background: #1a472a;
      color: #fff;
      border: 1px solid #4a7c4e;
    }
    .hr-race-btn {
      display: block;
      width: 100%;
      padding: 14px;
      margin-top: 12px;
      background: linear-gradient(180deg, #e63946 0%, #c1121f 100%);
      border: 2px solid #ff6b6b;
      border-radius: 10px;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .hr-race-btn:active { transform: scale(0.98); }
    .hr-race-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .hr-canvas-wrap {
      width: 100%;
      background: #0d2818;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #2d5a3d;
      display: none;
    }
    .hr-canvas-wrap.visible { display: block; }
    #hrCanvas { display: block; width: 100%; height: 200px; }
    .hr-result {
      background: rgba(0,0,0,0.4);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      border: 2px solid #4a7c4e;
      display: none;
    }
    .hr-result.visible { display: block; }
    .hr-result h3 { margin-bottom: 12px; color: #90ee90; }
    .hr-result .payout { font-size: 1.2rem; color: #ffd700; margin: 12px 0; }
    .hr-back { display: inline-block; margin-top: 16px; color: #98fb98; font-size: 14px; text-decoration: none; }
    .hr-back:hover { text-decoration: underline; }
  </style>
</head>
<body class="game-page">
  <div id="site-header"></div>

  <div class="hr-wrap">
    <h1 class="hr-title">ç«¶é¦¬ã‚²ãƒ¼ãƒ  ğŸ‡</h1>
    <div class="hr-hud">
      <span>æ‰€æŒé‡‘: <span class="money" id="hrMoney">1000</span> å††</span>
      <span class="hr-phase" id="hrPhase">é¦¬ä¸»ï¼†è²·ã„ç›®é¸æŠ</span>
    </div>

    <div class="hr-main" id="hrMain">
      <div class="hr-stable">
        <div class="hr-stable-title">ğŸ´ è‡ªåˆ†ã®å©èˆï¼ˆã‚¿ãƒƒãƒ—ã§èª¿æ•™ï¼‰</div>
        <div id="hrStableList"></div>
      </div>
      <div class="hr-bet-section">
        <div class="hr-bet-title">ğŸ’° é¦¬åˆ¸è³¼å…¥</div>
        <div class="hr-bet-row">
          <label>å˜å‹</label>
          <select id="hrTansho">
            <option value="">-- é¦¬ç•ªé¸æŠ --</option>
          </select>
          <input type="number" id="hrTanshoBet" min="100" step="100" value="100" placeholder="é‡‘é¡">
          <span>å††</span>
        </div>
        <div class="hr-bet-row">
          <label>è¤‡å‹</label>
          <select id="hrFukusho">
            <option value="">-- é¦¬ç•ªé¸æŠ --</option>
          </select>
          <input type="number" id="hrFukushoBet" min="100" step="100" value="100" placeholder="é‡‘é¡">
          <span>å††</span>
        </div>
        <button type="button" class="hr-race-btn" id="hrRaceBtn">ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼</button>
      </div>
    </div>

    <div class="hr-canvas-wrap" id="hrCanvasWrap">
      <canvas id="hrCanvas" width="400" height="200"></canvas>
    </div>

    <div class="hr-result" id="hrResult">
      <h3>ãƒ¬ãƒ¼ã‚¹çµæœ</h3>
      <p id="hrResultOrder"></p>
      <p class="payout" id="hrPayout"></p>
      <button type="button" class="hr-race-btn" id="hrNextBtn">æ¬¡ã®ãƒ¬ãƒ¼ã‚¹</button>
      <a href="/index.html" class="hr-back">â† ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
    </div>
  </div>

  <script src="/assets/header.js"></script>
  <script>
(function () {
  var HORSE_NAMES = ['ã‚µãƒ³ãƒ€ãƒ¼', 'ã‚¹ãƒ”ãƒ¼ãƒ‰', 'ãƒ©ã‚¤ãƒˆãƒ‹ãƒ³ã‚°', 'ãƒ•ã‚¡ã‚¤ã‚¢', 'ã‚¦ã‚£ãƒ³ãƒ‰', 'ã‚¹ã‚¿ãƒ¼', 'ãƒ ãƒ¼ãƒ³', 'ã‚µãƒ³ãƒ©ã‚¤ã‚º'];
  var state = {
    money: 1000,
    horses: [],
    phase: 'bet',
    raceResult: [],
    tanshoBet: 0,
    tanshoHorse: 0,
    fukushoBet: 0,
    fukushoHorse: 0
  };

  function initHorses() {
    state.horses = [];
    for (var i = 0; i < 8; i++) {
      state.horses.push({
        num: i + 1,
        name: HORSE_NAMES[i] + 'å·',
        power: 50 + Math.floor(Math.random() * 30),
        isMine: i === 0
      });
    }
    if (state.horses[0]) state.horses[0].name = 'ãƒã‚¤ãƒ›ãƒ¼ã‚¹';
  }

  function renderStable() {
    var el = document.getElementById('hrStableList');
    el.innerHTML = state.horses.map(function (h) {
      if (!h.isMine) return '';
      return '<div class="hr-horse-row">' +
        '<span class="hr-horse-num">' + h.num + '</span>' +
        '<span class="hr-horse-name">' + h.name + '</span>' +
        '<span class="hr-horse-power">ãƒ‘ãƒ¯ãƒ¼:' + h.power + '</span>' +
        '<button type="button" class="hr-tap-btn" data-num="' + h.num + '">èª¿æ•™ã™ã‚‹(Â¥100)</button>' +
        '</div>';
    }).filter(Boolean).join('');
    el.querySelectorAll('.hr-tap-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var num = parseInt(btn.dataset.num, 10);
        var h = state.horses.find(function (x) { return x.num === num; });
        if (h && state.money >= 100) {
          state.money -= 100;
          h.power = Math.min(99, h.power + 2);
          renderStable();
          document.getElementById('hrMoney').textContent = state.money;
        }
      });
    });
  }

  function renderBetSelects() {
    var opt = '<option value="">-- é¦¬ç•ªé¸æŠ --</option>' +
      state.horses.map(function (h) {
        return '<option value="' + h.num + '">' + h.num + ' ' + h.name + '</option>';
      }).join('');
    document.getElementById('hrTansho').innerHTML = opt;
    document.getElementById('hrFukusho').innerHTML = opt;
  }

  function runRace() {
    var tansho = parseInt(document.getElementById('hrTansho').value, 10);
    var tanshoBet = parseInt(document.getElementById('hrTanshoBet').value, 10) || 0;
    var fukusho = parseInt(document.getElementById('hrFukusho').value, 10);
    var fukushoBet = parseInt(document.getElementById('hrFukushoBet').value, 10) || 0;

    var totalBet = (tansho ? tanshoBet : 0) + (fukusho ? fukushoBet : 0);
    if (totalBet > state.money || totalBet <= 0) {
      alert('æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“');
      return;
    }

    state.money -= totalBet;
    state.tanshoBet = tansho ? tanshoBet : 0;
    state.tanshoHorse = tansho || 0;
    state.fukushoBet = fukusho ? fukushoBet : 0;
    state.fukushoHorse = fukusho || 0;

    state.phase = 'race';
    document.getElementById('hrMain').style.display = 'none';
    document.getElementById('hrCanvasWrap').classList.add('visible');
    document.getElementById('hrResult').classList.remove('visible');

    var horses = state.horses.map(function (h) {
      return { num: h.num, name: h.name, power: h.power, pos: 0 };
    });

    var raceLen = 400;
    var tickCount = 0;
    var maxTicks = 180;

    function raceTick() {
      tickCount++;
      horses.forEach(function (h) {
        var rnd = 0.8 + Math.random() * 0.4;
        h.pos += (h.power / 50) * rnd * 2;
      });
      horses.sort(function (a, b) { return b.pos - a.pos; });

      var canvas = document.getElementById('hrCanvas');
      var ctx = canvas.getContext('2d');
      ctx.fillStyle = '#0d2818';
      ctx.fillRect(0, 0, 400, 200);

      ctx.fillStyle = '#2d5a3d';
      ctx.fillRect(0, 180, 400, 20);

      horses.forEach(function (h, i) {
        var x = Math.min(360, h.pos * 360 / raceLen) + 20;
        var y = 30 + i * 20;
        ctx.fillStyle = h.num === 1 ? '#ffd700' : '#90ee90';
        ctx.beginPath();
        ctx.arc(x, y, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.font = '12px sans-serif';
        ctx.fillText(h.num + ' ' + h.name, x + 12, y + 4);
      });

      if (horses[0].pos >= raceLen || tickCount >= maxTicks) {
        state.raceResult = horses.map(function (h) { return h.num; });
        showResult();
        return;
      }
      requestAnimationFrame(raceTick);
    }
    raceTick();
  }

  function showResult() {
    document.getElementById('hrCanvasWrap').classList.remove('visible');
    document.getElementById('hrResult').classList.add('visible');

    var order = state.raceResult.map(function (n, i) {
      return (i + 1) + 'ç€: ' + n + 'ç•ª';
    }).join(' / ');
    document.getElementById('hrResultOrder').textContent = order;

    var payout = 0;
    var winHorse = state.raceResult[0];
    var placeHorses = state.raceResult.slice(0, 3);

    if (state.tanshoHorse === winHorse && state.tanshoBet > 0) {
      var odds = 2 + Math.floor(Math.random() * 8);
      payout += state.tanshoBet * odds;
    }
    if (placeHorses.indexOf(state.fukushoHorse) >= 0 && state.fukushoBet > 0) {
      var fukuOdds = 1 + Math.floor(Math.random() * 3);
      payout += state.fukushoBet * fukuOdds;
    }

    state.money += payout;
    document.getElementById('hrPayout').textContent = 'æ‰•æˆ»: ' + payout + ' å††ï¼ˆæ‰€æŒé‡‘: ' + state.money + ' å††ï¼‰';
    document.getElementById('hrMoney').textContent = state.money;
  }

  document.getElementById('hrNextBtn').addEventListener('click', function () {
    document.getElementById('hrResult').classList.remove('visible');
    document.getElementById('hrMain').style.display = 'flex';
    state.phase = 'bet';
    initHorses();
    renderStable();
    renderBetSelects();
    document.getElementById('hrPhase').textContent = 'é¦¬ä¸»ï¼†è²·ã„ç›®é¸æŠ';
  });

  document.getElementById('hrRaceBtn').addEventListener('click', runRace);

  initHorses();
  renderStable();
  renderBetSelects();
  document.getElementById('hrMoney').textContent = state.money;
})();
  </script>
</body>
</html>
